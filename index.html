<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>Vibe Dispatcher - Provoz</title>
    <style>
        body { background: #0a0a0a; color: #00ff41; font-family: 'Consolas', monospace; margin: 0; overflow: hidden; display: flex; flex-direction: column; align-items: center; }
        #header { width: 100%; padding: 10px; background: #111; border-bottom: 2px solid #333; text-align: center; }
        canvas { background: #000; border: 1px solid #222; margin-top: 10px; box-shadow: 0 0 20px rgba(0,255,65,0.1); }
        #console { width: 980px; height: 100px; background: #000; border: 1px solid #333; margin-top: 10px; padding: 10px; font-size: 0.8rem; overflow-y: auto; color: #888; }
        .btn-spawn { margin-top: 10px; padding: 10px; background: #00ff41; color: black; border: none; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

<div id="header">DISPEČERSKÉ PRACOVIŠTĚ: <span id="st-name">...</span></div>
<canvas id="jopCanvas" width="1000" height="400"></canvas>
<div id="console">>> Systém připraven. Čekám na data...</div>
<button class="btn-spawn" onclick="spawnTrain()">VYPLATIT VLAK</button>

<script>
    const canvas = document.getElementById('jopCanvas');
    const ctx = canvas.getContext('2d');
    let data = null;

    async function init() {
        try {
            const res = await fetch('./mapa.json');
            data = await res.json();
            document.getElementById('st-name').innerText = data.stanice[0].jmeno;
            log("Systém ONLINE. Vlaky připraveny k vypravení.");
            gameLoop();
        } catch (e) { log("Chyba načítání mapa.json!"); }
    }

    function log(msg) {
        const c = document.getElementById('console');
        c.innerHTML = `> ${msg}<br>` + c.innerHTML;
    }

    function draw() {
        if(!data) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const s = data.stanice[0];

        s.koleje.forEach(k => {
            ctx.strokeStyle = "#333"; ctx.lineWidth = 4;
            ctx.beginPath(); ctx.moveTo(k.x1, k.y1); ctx.lineTo(k.x2, k.y2); ctx.stroke();
        });

        s.vyhybky.forEach(w => {
            const target = w.targets[w.state];
            ctx.strokeStyle = "#fff";
            ctx.beginPath(); ctx.moveTo(w.x, w.y); ctx.lineTo(target[0], target[1]); ctx.stroke();
            ctx.fillStyle = "#ffaa00"; ctx.beginPath(); ctx.arc(w.x, w.y, 6, 0, 7); ctx.fill();
        });

        s.navestidla.forEach(n => {
            ctx.fillStyle = (n.state === "volno") ? "#00ff00" : "#ff0000";
            ctx.shadowBlur = 10; ctx.shadowColor = ctx.fillStyle;
            ctx.beginPath(); ctx.arc(n.x, n.y - 20, 8, 0, 7); ctx.fill();
            ctx.shadowBlur = 0;
            ctx.fillStyle = "#fff"; ctx.font = "bold 10px Arial";
            ctx.fillText(n.id, n.x - 15, n.y - 35);
        });

        s.vlaky.forEach(v => {
            if(!v.active) return;
            ctx.fillStyle = v.color;
            ctx.fillRect(v.x - 20, v.y - 10, 40, 20);
            ctx.fillStyle = "#000"; ctx.font = "bold 10px Arial";
            ctx.fillText(v.id, v.x - 18, v.y + 4);
        });
    }

    function update() {
        if(!data) return;
        const s = data.stanice[0];
        
        s.vlaky.forEach(v => {
            if(!v.active) return;

            // Logika zastavení před návěstidlem podle směru
            let canGo = true;
            s.navestidla.forEach(n => {
                // Pokud vlak jede doprava (dir: 1) a návěstidlo je před ním
                if(v.dir === 1 && v.x < n.x - 10 && v.x > n.x - 40 && n.state === "stoj") canGo = false;
                // Pokud vlak jede doleva (dir: -1) a návěstidlo je před ním
                if(v.dir === -1 && v.x > n.x + 10 && v.x < n.x + 40 && n.state === "stoj") canGo = false;

                // Shození návěstidla po průjezdu
                if(n.state === "volno" && Math.abs(v.x - n.x) < 5) {
                    n.state = "stoj";
                    log(`Vlak ${v.id} projel návěstidlo ${n.id}.`);
                }
            });

            if(canGo) {
                v.x += v.speed * v.dir;
            }

            // Výhybky - plynulé zatáčení
            if(v.dir === 1) { // Vlak doprava
                if(v.x > 240 && v.x < 260) v.tY = (s.vyhybky[0].state === 0) ? 250 : 150;
                if(v.x > 490 && v.x < 510) v.tY = (s.vyhybky[1].state === 0) ? 250 : 100;
            } else { // Vlak doleva
                if(v.x < 510 && v.x > 490) v.tY = 250;
                if(v.x < 260 && v.x > 240) v.tY = 250;
            }
            
            if(v.tY) v.y += (v.tY - v.y) * 0.1;

            // Konec trasy
            if((v.dir === 1 && v.x > v.targetX) || (v.dir === -1 && v.x < v.targetX)) v.active = false;
        });
    }

    function spawnTrain() {
        if(!data) return;
        // Vypustí oba vlaky
        data.stanice[0].vlaky.forEach(v => {
            if (v.dir === 1) { v.x = -50; v.y = 250; }
            else { v.x = 1050; v.y = 250; }
            v.active = true;
            v.tY = 250;
        });
        log("VLAKY VYSTAVENY: Os 4712 (Západ) a R 621 (Východ).");
    }

    canvas.addEventListener('click', (e) => {
        const rect = canvas.getBoundingClientRect();
        const mx = e.clientX - rect.left;
        const my = e.clientY - rect.top;
        
        data.stanice[0].vyhybky.forEach(w => {
            if(Math.hypot(mx-w.x, my-w.y) < 25) {
                w.state = w.state === 0 ? 1 : 0;
                log(`Výhybka ${w.id} přestavena.`);
            }
        });
        data.stanice[0].navestidla.forEach(n => {
            if(Math.hypot(mx-n.x, my-(n.y-20)) < 25) {
                n.state = (n.state === "stoj") ? "volno" : "stoj";
                log(`Návěstidlo ${n.id} přepnuto.`);
            }
        });
    });

    function gameLoop() { update(); draw(); requestAnimationFrame(gameLoop); }
    init();
</script>
</body>
</html>
