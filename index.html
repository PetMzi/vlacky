<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<title>JOP – Železniční Dispečink v3.0</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;700&display=swap');

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: #030508;
    color: #00ff41;
    font-family: 'Share Tech Mono', 'Consolas', monospace;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* ── Header ── */
  #header {
    background: linear-gradient(180deg, #0a0f14 0%, #050a0e 100%);
    border-bottom: 1px solid #1a2a1a;
    padding: 12px 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 2px 20px rgba(0,255,65,0.05);
  }
  #header h1 {
    font-family: 'Orbitron', monospace;
    font-size: 1rem;
    letter-spacing: 4px;
    color: #00ff41;
    text-shadow: 0 0 10px rgba(0,255,65,0.4);
  }
  .status-bar {
    display: flex;
    gap: 20px;
    font-size: 0.75rem;
    color: #556;
  }
  .status-bar .live { color: #00ff41; animation: blink 1.5s infinite; }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }

  /* ── Canvas ── */
  #canvasWrap {
    display: flex;
    justify-content: center;
    padding: 16px;
  }
  canvas {
    background: #000;
    border: 1px solid #111;
    border-radius: 2px;
    box-shadow: 0 0 40px rgba(0,255,65,0.04), inset 0 0 60px rgba(0,0,0,0.5);
    cursor: crosshair;
  }

  /* ── Controls ── */
  #controls {
    display: flex;
    justify-content: center;
    gap: 10px;
    padding: 8px 24px;
    flex-wrap: wrap;
  }
  .btn {
    padding: 10px 22px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.8rem;
    border: 1px solid #1a3a1a;
    background: #0a1a0a;
    color: #00ff41;
    cursor: pointer;
    letter-spacing: 1px;
    transition: all 0.2s;
  }
  .btn:hover {
    background: #00ff41;
    color: #000;
    box-shadow: 0 0 15px rgba(0,255,65,0.3);
  }
  .btn.danger { border-color: #3a1a1a; color: #ff4141; }
  .btn.danger:hover { background: #ff4141; color: #000; box-shadow: 0 0 15px rgba(255,65,65,0.3); }
  .btn.warn { border-color: #3a3a1a; color: #ffaa00; }
  .btn.warn:hover { background: #ffaa00; color: #000; }

  /* ── Console ── */
  #consoleWrap {
    display: flex;
    justify-content: center;
    padding: 0 24px 16px;
  }
  #console {
    width: 100%;
    max-width: 1200px;
    height: 150px;
    background: #020405;
    border: 1px solid #111;
    border-radius: 2px;
    padding: 10px 14px;
    font-size: 0.72rem;
    overflow-y: auto;
    color: #667;
    line-height: 1.6;
  }
  #console .info { color: #00ff41; }
  #console .warn { color: #ffaa00; }
  #console .err { color: #ff4141; }
  #console .dim { color: #334; }

  /* ── Info Panel ── */
  #infoPanel {
    display: flex;
    justify-content: center;
    gap: 16px;
    padding: 0 24px 16px;
    flex-wrap: wrap;
  }
  .info-card {
    background: #060a0e;
    border: 1px solid #152015;
    padding: 10px 16px;
    font-size: 0.7rem;
    min-width: 200px;
    border-radius: 2px;
  }
  .info-card h3 {
    color: #445;
    font-size: 0.65rem;
    letter-spacing: 2px;
    margin-bottom: 6px;
  }
  .info-card .val { color: #00ff41; font-size: 0.85rem; }

  /* ── Tooltip ── */
  #tooltip {
    position: fixed;
    background: #0a1510;
    border: 1px solid #1a3a1a;
    color: #00ff41;
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.7rem;
    padding: 6px 10px;
    pointer-events: none;
    display: none;
    z-index: 100;
    box-shadow: 0 0 10px rgba(0,255,65,0.15);
  }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: #000; }
  ::-webkit-scrollbar-thumb { background: #1a2a1a; }
</style>
</head>
<body>

<div id="header">
  <h1>⚡ JOP — CENTRÁLNÍ DISPEČINK v3.0</h1>
  <div class="status-bar">
    <span>ČAS: <span id="clock">--:--:--</span></span>
    <span class="live">● ONLINE</span>
    <span>VLAKY: <span id="trainCount">0</span></span>
    <span>ZPOŽDĚNÍ: <span id="delayCount">0</span></span>
  </div>
</div>

<div id="canvasWrap">
  <canvas id="jop" width="1200" height="520"></canvas>
</div>

<div id="controls">
  <button class="btn" onclick="spawnScheduled()">▶ SPUSTIT JÍZDNÍ ŘÁD</button>
  <button class="btn" onclick="spawnSingle('R 601','right')">+ R 601 →</button>
  <button class="btn" onclick="spawnSingle('Os 2814','right')">+ Os 2814 →</button>
  <button class="btn" onclick="spawnSingle('Ex 145','left')">← Ex 145 +</button>
  <button class="btn" onclick="spawnSingle('Nex 780','left')">← Nex 780 +</button>
  <button class="btn warn" onclick="toggleAuto()">⚙ AUTO REŽIM</button>
  <button class="btn danger" onclick="emergencyStop()">⛔ NOUZOVÉ ZASTAVENÍ</button>
</div>

<div id="infoPanel">
  <div class="info-card"><h3>AKTIVNÍ VLAKY</h3><div class="val" id="panelTrains">—</div></div>
  <div class="info-card"><h3>OBSAZENÉ KOLEJE</h3><div class="val" id="panelTracks">—</div></div>
  <div class="info-card"><h3>REŽIM</h3><div class="val" id="panelMode">MANUÁLNÍ</div></div>
  <div class="info-card"><h3>BEZPEČNOST</h3><div class="val" id="panelSafety" style="color:#00ff41">OK</div></div>
</div>

<div id="consoleWrap">
  <div id="console"></div>
</div>

<div id="tooltip"></div>

<script>
// ═══════════════════════════════════════════════════════════
//  JOP v3.0 — Třístanicová simulace železničního provozu
// ═══════════════════════════════════════════════════════════

const canvas = document.getElementById('jop');
const ctx = canvas.getContext('2d');
const W = canvas.width, H = canvas.height;

// ── Simulation time ──
let simTime = 0; // in ticks (60fps)
let autoMode = false;
let emergencyMode = false;
let trainIdCounter = 0;

// ── Three stations definition ──
// Layout:  [Zelená Lhota] ───── [Údolí] ───── [Skalná]
//           left edge        center          right edge

const STATIONS = [
  {
    name: "ZELENÁ LHOTA",
    cx: 150, // center x
    tracks: [
      { id: "ZL-K1", x1: 70, y1: 140, x2: 240, y2: 140 },
      { id: "ZL-K2", x1: 70, y1: 180, x2: 240, y2: 180 },
      { id: "ZL-K3", x1: 70, y1: 220, x2: 240, y2: 220 },
    ],
    switches: [
      { id: "ZL-V1", x: 55, y: 180, state: 1, targets: [[70,140],[70,180],[70,220]], label: "V1" },
      { id: "ZL-V2", x: 255, y: 180, state: 1, targets: [[240,140],[240,180],[240,220]], label: "V2" },
    ],
    signals: [
      { id: "ZL-L", x: 30, y: 180, state: "stoj", dir: 1, label: "L" },
      { id: "ZL-S1", x: 260, y: 140, state: "stoj", dir: 1, label: "S1" },
      { id: "ZL-S2", x: 260, y: 180, state: "stoj", dir: 1, label: "S2" },
      { id: "ZL-S3", x: 260, y: 220, state: "stoj", dir: 1, label: "S3" },
    ],
    platformY: [140, 180, 220],
  },
  {
    name: "ÚDOLÍ",
    cx: 600,
    tracks: [
      { id: "UD-K1", x1: 490, y1: 120, x2: 710, y2: 120 },
      { id: "UD-K2", x1: 490, y1: 160, x2: 710, y2: 160 },
      { id: "UD-K3", x1: 490, y1: 200, x2: 710, y2: 200 },
      { id: "UD-K4", x1: 490, y1: 240, x2: 710, y2: 240 },
    ],
    switches: [
      { id: "UD-V1", x: 475, y: 180, state: 1, targets: [[490,120],[490,160],[490,200],[490,240]], label: "V1" },
      { id: "UD-V2", x: 725, y: 180, state: 1, targets: [[710,120],[710,160],[710,200],[710,240]], label: "V2" },
    ],
    signals: [
      { id: "UD-L", x: 450, y: 180, state: "stoj", dir: 1, label: "L" },
      { id: "UD-S1", x: 735, y: 120, state: "stoj", dir: 1, label: "S1" },
      { id: "UD-S2", x: 735, y: 160, state: "stoj", dir: 1, label: "S2" },
      { id: "UD-S3", x: 735, y: 200, state: "stoj", dir: 1, label: "S3" },
      { id: "UD-S4", x: 735, y: 240, state: "stoj", dir: 1, label: "S4" },
      { id: "UD-Lp", x: 750, y: 180, state: "stoj", dir: -1, label: "Lp" },
    ],
    platformY: [120, 160, 200, 240],
  },
  {
    name: "SKALNÁ",
    cx: 1050,
    tracks: [
      { id: "SK-K1", x1: 960, y1: 140, x2: 1130, y2: 140 },
      { id: "SK-K2", x1: 960, y1: 180, x2: 1130, y2: 180 },
      { id: "SK-K3", x1: 960, y1: 220, x2: 1130, y2: 220 },
    ],
    switches: [
      { id: "SK-V1", x: 945, y: 180, state: 1, targets: [[960,140],[960,180],[960,220]], label: "V1" },
      { id: "SK-V2", x: 1145, y: 180, state: 1, targets: [[1130,140],[1130,180],[1130,220]], label: "V2" },
    ],
    signals: [
      { id: "SK-Lp", x: 940, y: 180, state: "stoj", dir: -1, label: "Lp" },
      { id: "SK-S1", x: 930, y: 140, state: "stoj", dir: -1, label: "S1" },
      { id: "SK-S2", x: 930, y: 180, state: "stoj", dir: -1, label: "S2" },
      { id: "SK-S3", x: 930, y: 220, state: "stoj", dir: -1, label: "S3" },
      { id: "SK-R", x: 1165, y: 180, state: "stoj", dir: -1, label: "R" },
    ],
    platformY: [140, 180, 220],
  }
];

// ── Interconnecting tracks (between stations) ──
const LINES = [
  { id: "trat-1", x1: 270, y1: 180, x2: 460, y2: 180, label: "Trať 1: ZL → ÚD" },
  { id: "trat-1b", x1: 270, y1: 340, x2: 460, y2: 340, label: "Trať 2: ÚD → ZL" },
  { id: "trat-2", x1: 740, y1: 180, x2: 930, y2: 180, label: "Trať 3: ÚD → SK" },
  { id: "trat-2b", x1: 740, y1: 340, x2: 930, y2: 340, label: "Trať 4: SK → ÚD" },
];

// Open-track signals (mezistanice / autoblok)
const LINE_SIGNALS = [
  { id: "Ab-1", x: 365, y: 180, state: "stoj", dir: 1, label: "Ab1" },
  { id: "Ab-2", x: 365, y: 340, state: "stoj", dir: -1, label: "Ab2" },
  { id: "Ab-3", x: 835, y: 180, state: "stoj", dir: 1, label: "Ab3" },
  { id: "Ab-4", x: 835, y: 340, state: "stoj", dir: -1, label: "Ab4" },
];

// ── Trains ──
let trains = [];

const TRAIN_TYPES = {
  "R":   { color: "#3b82f6", speed: 1.8, priority: 3, len: 50 },
  "Os":  { color: "#a3e635", speed: 1.2, priority: 1, len: 36 },
  "Ex":  { color: "#f59e0b", speed: 2.2, priority: 4, len: 55 },
  "Nex": { color: "#ef4444", speed: 1.0, priority: 2, len: 60 },
  "SC":  { color: "#c084fc", speed: 2.5, priority: 5, len: 48 },
};

function getTrainType(name) {
  const prefix = name.split(' ')[0];
  return TRAIN_TYPES[prefix] || TRAIN_TYPES["Os"];
}

// ── All interactable signals (flat) ──
function getAllSignals() {
  const sigs = [];
  STATIONS.forEach(s => s.signals.forEach(sig => sigs.push(sig)));
  LINE_SIGNALS.forEach(sig => sigs.push(sig));
  return sigs;
}

function getAllSwitches() {
  const sw = [];
  STATIONS.forEach(s => s.switches.forEach(w => sw.push({ ...w, station: s.name })));
  return sw;
}

// ═══════════════════════════════════════════════════════════
//  TRAIN SPAWNING
// ═══════════════════════════════════════════════════════════

function createTrain(name, dir) {
  const type = getTrainType(name);
  const id = ++trainIdCounter;
  const train = {
    uid: id,
    name: name,
    dir: dir === 'right' ? 1 : -1,
    x: dir === 'right' ? -80 : W + 80,
    y: dir === 'right' ? 180 : 180,
    targetY: null,
    speed: type.speed,
    maxSpeed: type.speed,
    color: type.color,
    len: type.len,
    priority: type.priority,
    active: true,
    stopped: false,
    stoppedAt: null,
    phase: 'entering', // entering, in-station, line, exiting
    currentStation: null,
    visitedStations: [],
    dwellTimer: 0,
    dwellDuration: 0,
  };
  trains.push(train);
  log(`Vlak <span class="info">${name}</span> vypraven (${dir === 'right' ? '→' : '←'})`, 'info');
  return train;
}

function spawnSingle(name, dir) {
  if (emergencyMode) { log('Nouzové zastavení aktivní!', 'err'); return; }
  createTrain(name, dir);
}

function spawnScheduled() {
  if (emergencyMode) { log('Nouzové zastavení aktivní!', 'err'); return; }
  log('Spouštím jízdní řád...', 'info');
  const schedule = [
    { name: "R 601", dir: "right", delay: 0 },
    { name: "Os 2814", dir: "right", delay: 180 },
    { name: "Ex 145", dir: "left", delay: 90 },
    { name: "Nex 780", dir: "left", delay: 300 },
    { name: "SC 510", dir: "right", delay: 220 },
    { name: "Os 3021", dir: "left", delay: 400 },
  ];
  schedule.forEach(s => {
    setTimeout(() => {
      if (!emergencyMode) createTrain(s.name, s.dir);
    }, s.delay * 16);
  });
}

// ═══════════════════════════════════════════════════════════
//  AUTO MODE — automatic signal/switch control
// ═══════════════════════════════════════════════════════════

function toggleAuto() {
  autoMode = !autoMode;
  document.getElementById('panelMode').textContent = autoMode ? 'AUTOMATICKÝ' : 'MANUÁLNÍ';
  document.getElementById('panelMode').style.color = autoMode ? '#ffaa00' : '#00ff41';
  log(autoMode ? 'Automatický režim ZAPNUT' : 'Automatický režim VYPNUT', 'warn');
}

function autoControl() {
  if (!autoMode) return;

  trains.forEach(t => {
    if (!t.active) return;

    // For each station, find approaching trains and set signals/switches
    STATIONS.forEach((st, si) => {
      const entering = t.dir === 1
        ? (t.x > st.cx - 200 && t.x < st.cx - 120)
        : (t.x < st.cx + 200 && t.x > st.cx + 120);

      if (entering && !t.currentStation) {
        // Find a free track
        const freeIdx = findFreeTrack(st, t);
        if (freeIdx >= 0) {
          // Set entry switch
          const entrySwitch = t.dir === 1 ? st.switches[0] : st.switches[st.switches.length - 1];
          entrySwitch.state = freeIdx;

          // Set entry signal to volno
          const entrySigs = st.signals.filter(s =>
            (t.dir === 1 && s.dir === 1 && s.label === 'L') ||
            (t.dir === -1 && s.dir === -1 && (s.label === 'Lp' || s.label === 'R'))
          );
          entrySigs.forEach(s => s.state = 'volno');
        }
      }

      // Departing: set exit signal
      const inStation = t.currentStation === st.name && t.dwellTimer <= 0 && t.phase === 'in-station';
      if (inStation) {
        const exitSwitch = t.dir === 1 ? st.switches[st.switches.length - 1] : st.switches[0];
        // Route to main line
        exitSwitch.state = Math.floor(exitSwitch.targets.length / 2); // middle track → mainline

        // Set departure signal
        const trackIdx = st.platformY.indexOf(Math.round(t.y));
        const depSigs = st.signals.filter(s =>
          (t.dir === 1 && s.dir === 1 && s.label.startsWith('S')) ||
          (t.dir === -1 && s.dir === -1 && s.label.startsWith('S'))
        );
        if (depSigs[trackIdx]) depSigs[trackIdx].state = 'volno';

        // Also open line signals
        LINE_SIGNALS.forEach(ls => {
          if (ls.dir === t.dir) ls.state = 'volno';
        });
      }
    });
  });
}

function findFreeTrack(station, train) {
  const occupied = new Set();
  trains.forEach(t => {
    if (!t.active || t.uid === train.uid) return;
    if (t.currentStation === station.name) {
      const yi = station.platformY.indexOf(Math.round(t.y));
      if (yi >= 0) occupied.add(yi);
    }
  });
  for (let i = 0; i < station.platformY.length; i++) {
    if (!occupied.has(i)) return i;
  }
  return -1;
}

// ═══════════════════════════════════════════════════════════
//  EMERGENCY
// ═══════════════════════════════════════════════════════════

function emergencyStop() {
  emergencyMode = !emergencyMode;
  if (emergencyMode) {
    getAllSignals().forEach(s => s.state = 'stoj');
    trains.forEach(t => t.stopped = true);
    log('⛔ NOUZOVÉ ZASTAVENÍ AKTIVOVÁNO!', 'err');
    document.getElementById('panelSafety').textContent = '⛔ NOUZOVÉ';
    document.getElementById('panelSafety').style.color = '#ff4141';
  } else {
    trains.forEach(t => t.stopped = false);
    log('Nouzové zastavení ZRUŠENO.', 'warn');
    document.getElementById('panelSafety').textContent = 'OK';
    document.getElementById('panelSafety').style.color = '#00ff41';
  }
}

// ═══════════════════════════════════════════════════════════
//  PHYSICS / UPDATE
// ═══════════════════════════════════════════════════════════

function update() {
  simTime++;

  autoControl();

  trains.forEach(t => {
    if (!t.active || t.stopped) return;

    // ── Signal checking ──
    let blocked = false;
    getAllSignals().forEach(sig => {
      if (sig.state !== 'stoj') return;
      const dist = (t.x - sig.x) * t.dir;
      if (dist > -60 && dist < -5) {
        // Check if signal is roughly on same Y
        if (Math.abs(t.y - sig.y) < 50) {
          blocked = true;
          t.stoppedAt = sig.id;
        }
      }
    });

    if (blocked) {
      t.speed = Math.max(0, t.speed - 0.05);
    } else {
      t.stoppedAt = null;
      t.speed = Math.min(t.maxSpeed, t.speed + 0.02);
    }

    // ── Station dwell ──
    STATIONS.forEach(st => {
      const inZone = t.x > st.cx - 80 && t.x < st.cx + 80;
      if (inZone && !t.visitedStations.includes(st.name) && t.phase !== 'in-station') {
        // Enter station
        t.currentStation = st.name;
        t.phase = 'in-station';

        // Determine dwell (express trains shorter)
        const isExpress = t.priority >= 4;
        t.dwellDuration = isExpress ? 90 : 180; // ticks
        t.dwellTimer = t.dwellDuration;

        log(`${t.name} vjíždí do stanice <span class="info">${st.name}</span>`, 'info');
      }
    });

    if (t.dwellTimer > 0) {
      t.dwellTimer--;
      t.speed = 0;
      if (t.dwellTimer === 0) {
        t.visitedStations.push(t.currentStation);
        log(`${t.name} odjíždí z <span class="info">${t.currentStation}</span>`, 'info');
        t.currentStation = null;
        t.phase = 'line';
      }
      return;
    }

    // ── Switch routing (Y targeting) ──
    STATIONS.forEach(st => {
      st.switches.forEach(sw => {
        const dist = Math.abs(t.x - sw.x);
        if (dist < 15) {
          const target = sw.targets[sw.state];
          t.targetY = target[1];
        }
      });
    });

    // ── Y interpolation ──
    if (t.targetY !== null) {
      const dy = t.targetY - t.y;
      if (Math.abs(dy) > 0.5) {
        t.y += dy * 0.08;
      } else {
        t.y = t.targetY;
        t.targetY = null;
      }
    }

    // ── Move ──
    t.x += t.speed * t.dir;

    // ── Signal auto-close behind train ──
    getAllSignals().forEach(sig => {
      const passed = (t.dir === 1 && t.x > sig.x + 15 && t.x < sig.x + 25) ||
                     (t.dir === -1 && t.x < sig.x - 15 && t.x > sig.x - 25);
      if (passed && sig.state === 'volno' && Math.abs(t.y - sig.y) < 50) {
        sig.state = 'stoj';
      }
    });

    // ── Remove if off-screen ──
    if (t.x > W + 150 || t.x < -150) {
      t.active = false;
      log(`${t.name} opustil síť.`, 'dim');
    }
  });

  // Cleanup
  trains = trains.filter(t => t.active);

  // ── Collision detection ──
  for (let i = 0; i < trains.length; i++) {
    for (let j = i + 1; j < trains.length; j++) {
      const a = trains[i], b = trains[j];
      if (!a.active || !b.active) continue;
      if (Math.abs(a.y - b.y) < 15 && Math.abs(a.x - b.x) < 35) {
        log(`⚠ KOLIZE HROZÍ: ${a.name} ↔ ${b.name}!`, 'err');
        a.speed = 0; b.speed = 0;
        document.getElementById('panelSafety').textContent = '⚠ KOLIZE';
        document.getElementById('panelSafety').style.color = '#ff4141';
      }
    }
  }

  updatePanel();
}

// ═══════════════════════════════════════════════════════════
//  DRAWING
// ═══════════════════════════════════════════════════════════

function draw() {
  ctx.clearRect(0, 0, W, H);

  // ── Background grid ──
  ctx.strokeStyle = '#080c08';
  ctx.lineWidth = 0.5;
  for (let x = 0; x < W; x += 40) {
    ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, H); ctx.stroke();
  }
  for (let y = 0; y < H; y += 40) {
    ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W, y); ctx.stroke();
  }

  // ── Interconnecting lines ──
  LINES.forEach(l => {
    ctx.strokeStyle = '#1a1a1a';
    ctx.lineWidth = 3;
    ctx.setLineDash([8, 6]);
    ctx.beginPath();
    ctx.moveTo(l.x1, l.y1);
    ctx.lineTo(l.x2, l.y2);
    ctx.stroke();
    ctx.setLineDash([]);

    // Label
    ctx.fillStyle = '#1a2a1a';
    ctx.font = '9px Share Tech Mono';
    const mx = (l.x1 + l.x2) / 2, my = (l.y1 + l.y2) / 2;
    ctx.fillText(l.label, mx - 30, my - 8);
  });

  // ── Stations ──
  STATIONS.forEach(st => {
    // Station area
    const x1 = st.tracks[0].x1 - 20;
    const x2 = st.tracks[0].x2 + 20;
    const y1 = st.tracks[0].y1 - 30;
    const y2 = st.tracks[st.tracks.length - 1].y2 + 30;

    ctx.fillStyle = 'rgba(0,255,65,0.015)';
    ctx.fillRect(x1, y1, x2 - x1, y2 - y1);
    ctx.strokeStyle = '#0a1a0a';
    ctx.lineWidth = 1;
    ctx.strokeRect(x1, y1, x2 - x1, y2 - y1);

    // Station name
    ctx.fillStyle = '#00ff41';
    ctx.font = 'bold 11px Orbitron';
    ctx.textAlign = 'center';
    ctx.fillText(st.name, st.cx, y1 - 8);
    ctx.textAlign = 'left';

    // Tracks
    st.tracks.forEach(tk => {
      // Check if occupied
      const occ = trains.some(t => t.active && Math.abs(t.y - tk.y1) < 15 && t.x > tk.x1 - 30 && t.x < tk.x2 + 30);
      ctx.strokeStyle = occ ? '#1a3a1a' : '#1a1a1a';
      ctx.lineWidth = occ ? 5 : 3;
      ctx.beginPath();
      ctx.moveTo(tk.x1, tk.y1);
      ctx.lineTo(tk.x2, tk.y2);
      ctx.stroke();

      // Track label
      ctx.fillStyle = '#223322';
      ctx.font = '8px Share Tech Mono';
      ctx.fillText(tk.id, tk.x1, tk.y1 - 6);

      // Platform markers
      if (occ) {
        ctx.fillStyle = 'rgba(0,255,65,0.08)';
        ctx.fillRect(tk.x1, tk.y1 - 10, tk.x2 - tk.x1, 20);
      }
    });

    // Switches
    st.switches.forEach(sw => {
      const target = sw.targets[sw.state];

      // Draw switch route
      ctx.strokeStyle = '#ffaa00';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(sw.x, sw.y);
      ctx.lineTo(target[0], target[1]);
      ctx.stroke();

      // All possible routes (dim)
      sw.targets.forEach((tg, i) => {
        if (i === sw.state) return;
        ctx.strokeStyle = '#221800';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(sw.x, sw.y);
        ctx.lineTo(tg[0], tg[1]);
        ctx.stroke();
      });

      // Switch dot
      ctx.fillStyle = '#ffaa00';
      ctx.shadowBlur = 6;
      ctx.shadowColor = '#ffaa00';
      ctx.beginPath();
      ctx.arc(sw.x, sw.y, 5, 0, Math.PI * 2);
      ctx.fill();
      ctx.shadowBlur = 0;

      // Label
      ctx.fillStyle = '#886600';
      ctx.font = '9px Share Tech Mono';
      ctx.fillText(sw.label, sw.x - 5, sw.y + 16);
    });

    // Signals
    st.signals.forEach(sig => drawSignal(sig));
  });

  // ── Line signals ──
  LINE_SIGNALS.forEach(sig => drawSignal(sig));

  // ── Trains ──
  trains.forEach(t => {
    if (!t.active) return;
    const hw = t.len / 2;

    // Body shadow
    ctx.fillStyle = 'rgba(0,0,0,0.4)';
    ctx.fillRect(t.x - hw, t.y - 6 + 2, t.len, 14);

    // Body
    const grad = ctx.createLinearGradient(t.x - hw, t.y - 7, t.x - hw, t.y + 7);
    grad.addColorStop(0, t.color);
    grad.addColorStop(1, shadeColor(t.color, -40));
    ctx.fillStyle = grad;
    ctx.fillRect(t.x - hw, t.y - 7, t.len, 14);

    // Border
    ctx.strokeStyle = 'rgba(255,255,255,0.15)';
    ctx.lineWidth = 0.5;
    ctx.strokeRect(t.x - hw, t.y - 7, t.len, 14);

    // Headlight
    const hlx = t.dir === 1 ? t.x + hw : t.x - hw;
    ctx.fillStyle = '#fff';
    ctx.shadowBlur = 8;
    ctx.shadowColor = '#fff';
    ctx.beginPath();
    ctx.arc(hlx, t.y, 2, 0, Math.PI * 2);
    ctx.fill();
    ctx.shadowBlur = 0;

    // Name label
    ctx.fillStyle = '#fff';
    ctx.font = 'bold 8px Share Tech Mono';
    ctx.textAlign = 'center';
    ctx.fillText(t.name, t.x, t.y - 12);

    // Speed indicator
    if (t.speed > 0) {
      ctx.fillStyle = '#556';
      ctx.font = '7px Share Tech Mono';
      ctx.fillText(Math.round(t.speed * 50) + ' km/h', t.x, t.y + 22);
    } else if (t.dwellTimer > 0) {
      ctx.fillStyle = '#ffaa00';
      ctx.font = '7px Share Tech Mono';
      ctx.fillText('⏱ ' + Math.ceil(t.dwellTimer / 60) + 's', t.x, t.y + 22);
    } else if (t.stoppedAt) {
      ctx.fillStyle = '#ff4141';
      ctx.font = '7px Share Tech Mono';
      ctx.fillText('STOJ', t.x, t.y + 22);
    }
    ctx.textAlign = 'left';
  });

  // ── Bottom bar: line diagram ──
  drawLineDiagram();
}

function drawSignal(sig) {
  const isGo = sig.state === 'volno';
  const col = isGo ? '#00ff41' : '#ff2222';

  // Pole
  ctx.strokeStyle = '#333';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(sig.x, sig.y);
  ctx.lineTo(sig.x, sig.y - 24);
  ctx.stroke();

  // Light
  ctx.fillStyle = col;
  ctx.shadowBlur = isGo ? 12 : 8;
  ctx.shadowColor = col;
  ctx.beginPath();
  ctx.arc(sig.x, sig.y - 28, 6, 0, Math.PI * 2);
  ctx.fill();

  // Second light (housing)
  ctx.fillStyle = '#111';
  ctx.shadowBlur = 0;
  ctx.beginPath();
  ctx.arc(sig.x, sig.y - 40, 5, 0, Math.PI * 2);
  ctx.fill();
  ctx.fillStyle = isGo ? '#222' : '#ffaa00';
  ctx.beginPath();
  ctx.arc(sig.x, sig.y - 40, 3.5, 0, Math.PI * 2);
  ctx.fill();

  // Label
  ctx.fillStyle = '#445';
  ctx.font = '8px Share Tech Mono';
  ctx.fillText(sig.label, sig.x - 6, sig.y + 12);
}

function drawLineDiagram() {
  const y = H - 40;

  ctx.fillStyle = '#0a0a0a';
  ctx.fillRect(0, H - 65, W, 65);
  ctx.strokeStyle = '#111';
  ctx.lineWidth = 1;
  ctx.beginPath(); ctx.moveTo(0, H - 65); ctx.lineTo(W, H - 65); ctx.stroke();

  // Line
  ctx.strokeStyle = '#222';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(50, y);
  ctx.lineTo(W - 50, y);
  ctx.stroke();

  // Station dots
  STATIONS.forEach(st => {
    ctx.fillStyle = '#00ff41';
    ctx.beginPath();
    ctx.arc(st.cx, y, 4, 0, Math.PI * 2);
    ctx.fill();

    ctx.fillStyle = '#556';
    ctx.font = '9px Share Tech Mono';
    ctx.textAlign = 'center';
    ctx.fillText(st.name, st.cx, y + 14);
    ctx.textAlign = 'left';
  });

  // Train positions on diagram
  trains.forEach(t => {
    if (!t.active) return;
    ctx.fillStyle = t.color;
    ctx.beginPath();
    ctx.arc(t.x, y, 3, 0, Math.PI * 2);
    ctx.fill();

    // Direction arrow
    const ax = t.dir === 1 ? 5 : -5;
    ctx.beginPath();
    ctx.moveTo(t.x + ax, y - 3);
    ctx.lineTo(t.x + ax + t.dir * 4, y);
    ctx.lineTo(t.x + ax, y + 3);
    ctx.fillStyle = t.color;
    ctx.fill();
  });
}

// ═══════════════════════════════════════════════════════════
//  INTERACTION
// ═══════════════════════════════════════════════════════════

canvas.addEventListener('click', (e) => {
  const rect = canvas.getBoundingClientRect();
  const mx = (e.clientX - rect.left) * (W / rect.width);
  const my = (e.clientY - rect.top) * (H / rect.height);

  // Click on switches
  STATIONS.forEach(st => {
    st.switches.forEach(sw => {
      if (Math.hypot(mx - sw.x, my - sw.y) < 18) {
        sw.state = (sw.state + 1) % sw.targets.length;
        log(`Výhybka ${st.name}/${sw.label} → pozice ${sw.state + 1}`, 'warn');
      }
    });
  });

  // Click on signals
  getAllSignals().forEach(sig => {
    if (Math.hypot(mx - sig.x, my - (sig.y - 28)) < 16) {
      sig.state = sig.state === 'stoj' ? 'volno' : 'stoj';
      const stateText = sig.state === 'volno' ? 'VOLNO ●' : 'STŮJ ●';
      log(`Návěstidlo ${sig.label}: ${stateText}`, sig.state === 'volno' ? 'info' : 'warn');
    }
  });
});

// ── Tooltip on hover ──
const tooltip = document.getElementById('tooltip');
canvas.addEventListener('mousemove', (e) => {
  const rect = canvas.getBoundingClientRect();
  const mx = (e.clientX - rect.left) * (W / rect.width);
  const my = (e.clientY - rect.top) * (H / rect.height);

  let tip = null;

  // Switches
  STATIONS.forEach(st => {
    st.switches.forEach(sw => {
      if (Math.hypot(mx - sw.x, my - sw.y) < 18) {
        tip = `Výhybka ${st.name}/${sw.label} — pozice ${sw.state + 1}/${sw.targets.length} [klik = přepnout]`;
      }
    });
  });

  // Signals
  getAllSignals().forEach(sig => {
    if (Math.hypot(mx - sig.x, my - (sig.y - 28)) < 16) {
      tip = `Návěstidlo ${sig.label}: ${sig.state === 'volno' ? 'VOLNO' : 'STŮJ'} [klik = přepnout]`;
    }
  });

  // Trains
  trains.forEach(t => {
    if (t.active && Math.abs(mx - t.x) < t.len / 2 && Math.abs(my - t.y) < 12) {
      const spd = Math.round(t.speed * 50);
      const station = t.currentStation || 'na trati';
      tip = `${t.name} | ${spd} km/h | ${station}`;
      if (t.dwellTimer > 0) tip += ` | odjezd za ${Math.ceil(t.dwellTimer / 60)}s`;
      if (t.stoppedAt) tip += ` | blokováno: ${t.stoppedAt}`;
    }
  });

  if (tip) {
    tooltip.style.display = 'block';
    tooltip.textContent = tip;
    tooltip.style.left = (e.clientX + 12) + 'px';
    tooltip.style.top = (e.clientY - 8) + 'px';
  } else {
    tooltip.style.display = 'none';
  }
});

// ═══════════════════════════════════════════════════════════
//  PANEL / CLOCK / LOG
// ═══════════════════════════════════════════════════════════

function updatePanel() {
  const active = trains.filter(t => t.active);
  document.getElementById('trainCount').textContent = active.length;

  const stopped = active.filter(t => t.stoppedAt);
  document.getElementById('delayCount').textContent = stopped.length;

  document.getElementById('panelTrains').textContent =
    active.map(t => t.name).join(', ') || '—';

  const occTracks = new Set();
  trains.forEach(t => {
    if (!t.active) return;
    STATIONS.forEach(st => {
      st.tracks.forEach(tk => {
        if (Math.abs(t.y - tk.y1) < 15 && t.x > tk.x1 - 30 && t.x < tk.x2 + 30) {
          occTracks.add(tk.id);
        }
      });
    });
  });
  document.getElementById('panelTracks').textContent =
    occTracks.size > 0 ? [...occTracks].join(', ') : '—';
}

function updateClock() {
  const now = new Date();
  document.getElementById('clock').textContent =
    now.toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
}
setInterval(updateClock, 1000);
updateClock();

function log(msg, cls = '') {
  const c = document.getElementById('console');
  const time = new Date().toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
  c.innerHTML = `<span class="dim">[${time}]</span> <span class="${cls}">${msg}</span><br>` + c.innerHTML;
  // Keep max lines
  const lines = c.innerHTML.split('<br>');
  if (lines.length > 200) c.innerHTML = lines.slice(0, 200).join('<br>');
}

// ═══════════════════════════════════════════════════════════
//  HELPERS
// ═══════════════════════════════════════════════════════════

function shadeColor(color, percent) {
  const num = parseInt(color.replace('#', ''), 16);
  const r = Math.min(255, Math.max(0, (num >> 16) + percent));
  const g = Math.min(255, Math.max(0, ((num >> 8) & 0x00FF) + percent));
  const b = Math.min(255, Math.max(0, (num & 0x0000FF) + percent));
  return `rgb(${r},${g},${b})`;
}

// ═══════════════════════════════════════════════════════════
//  GAME LOOP
// ═══════════════════════════════════════════════════════════

function gameLoop() {
  update();
  draw();
  requestAnimationFrame(gameLoop);
}

log('Systém JOP v3.0 inicializován.', 'info');
log('3 stanice: Zelená Lhota — Údolí — Skalná', 'info');
log('Kliknutím na návěstidlo/výhybku přepnete stav.', 'dim');
gameLoop();
</script>
</body>
</html>
