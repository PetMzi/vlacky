<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<title>JOP â€“ Å½elezniÄnÃ­ DispeÄink v3.2</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;700&display=swap');

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: #000;
    color: #00ff41;
    font-family: 'Share Tech Mono', 'Consolas', monospace;
    min-height: 100vh;
    overflow-x: hidden;
  }

  #header {
    background: #000;
    border-bottom: 2px solid #00ff41;
    padding: 10px 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  #header h1 {
    font-family: 'Orbitron', monospace;
    font-size: 1rem;
    letter-spacing: 4px;
    color: #00ff41;
    text-shadow: 0 0 12px rgba(0,255,65,0.6);
  }
  .status-bar {
    display: flex;
    gap: 24px;
    font-size: 0.78rem;
    color: #888;
  }
  .status-bar .live { color: #00ff41; animation: blink 1.2s infinite; }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.2} }

  #canvasWrap { display: flex; justify-content: center; padding: 12px; position: relative; }
  canvas {
    background: #000;
    border: 2px solid #1a1a1a;
    cursor: crosshair;
    image-rendering: pixelated;
  }

  #controls {
    display: flex;
    justify-content: center;
    gap: 8px;
    padding: 6px 24px;
    flex-wrap: wrap;
  }
  .btn {
    padding: 10px 20px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.78rem;
    border: 2px solid #00ff41;
    background: #000;
    color: #00ff41;
    cursor: pointer;
    letter-spacing: 1px;
    transition: all 0.15s;
    text-transform: uppercase;
  }
  .btn:hover { background: #00ff41; color: #000; }
  .btn.danger { border-color: #ff0000; color: #ff0000; }
  .btn.danger:hover { background: #ff0000; color: #000; }
  .btn.warn { border-color: #ffaa00; color: #ffaa00; }
  .btn.warn:hover { background: #ffaa00; color: #000; }
  .btn.tutorial { border-color: #00ccff; color: #00ccff; }
  .btn.tutorial:hover { background: #00ccff; color: #000; }
  .btn.tutorial.active { background: #00ccff; color: #000; animation: pulse 1.5s infinite; }
  @keyframes pulse { 0%,100%{ box-shadow: 0 0 5px #00ccff; } 50%{ box-shadow: 0 0 20px #00ccff; } }

  #consoleWrap { display: flex; justify-content: center; padding: 0 24px 12px; }
  #console {
    width: 100%;
    max-width: 1200px;
    height: 130px;
    background: #000;
    border: 1px solid #222;
    padding: 8px 12px;
    font-size: 0.72rem;
    overflow-y: auto;
    color: #555;
    line-height: 1.7;
  }
  #console .info { color: #00ff41; }
  #console .warn { color: #ffaa00; }
  #console .err { color: #ff0000; }
  #console .dim { color: #333; }
  #console .tut { color: #00ccff; }

  #infoPanel {
    display: flex;
    justify-content: center;
    gap: 12px;
    padding: 0 24px 10px;
    flex-wrap: wrap;
  }
  .info-card {
    background: #000;
    border: 1px solid #222;
    padding: 8px 14px;
    font-size: 0.72rem;
    min-width: 180px;
  }
  .info-card h3 { color: #666; font-size: 0.62rem; letter-spacing: 2px; margin-bottom: 4px; }
  .info-card .val { color: #00ff41; font-size: 0.82rem; }

  #tooltip {
    position: fixed;
    background: #000;
    border: 1px solid #00ff41;
    color: #00ff41;
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.7rem;
    padding: 5px 10px;
    pointer-events: none;
    display: none;
    z-index: 100;
  }

  /* â”€â”€ Tutorial overlay â”€â”€ */
  #tutOverlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    z-index: 200;
    justify-content: center;
    align-items: center;
  }
  #tutOverlay.show { display: flex; }
  #tutBox {
    background: #000;
    border: 2px solid #00ccff;
    max-width: 560px;
    width: 90%;
    padding: 28px 32px;
    position: relative;
    box-shadow: 0 0 40px rgba(0,204,255,0.15);
  }
  #tutBox h2 {
    font-family: 'Orbitron', monospace;
    color: #00ccff;
    font-size: 0.95rem;
    letter-spacing: 2px;
    margin-bottom: 14px;
    text-shadow: 0 0 8px rgba(0,204,255,0.4);
  }
  #tutBox p, #tutBox li {
    color: #aaa;
    font-size: 0.78rem;
    line-height: 1.8;
    margin-bottom: 8px;
  }
  #tutBox .key { color: #ffaa00; font-weight: bold; }
  #tutBox .green { color: #00ff41; }
  #tutBox .red { color: #ff3333; }
  #tutBox .cyan { color: #00ccff; }
  #tutBox ul { list-style: none; padding-left: 12px; }
  #tutBox ul li::before { content: "â–¸ "; color: #00ccff; }
  #tutStep {
    color: #555;
    font-size: 0.65rem;
    letter-spacing: 1px;
    margin-bottom: 10px;
  }
  .tut-buttons {
    display: flex;
    gap: 10px;
    margin-top: 18px;
  }
  .tut-btn {
    padding: 10px 22px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.78rem;
    border: 2px solid #00ccff;
    background: transparent;
    color: #00ccff;
    cursor: pointer;
    letter-spacing: 1px;
    transition: all 0.15s;
  }
  .tut-btn:hover { background: #00ccff; color: #000; }
  .tut-btn.primary { background: #00ccff; color: #000; }
  .tut-btn.primary:hover { background: #00eeff; }
  .tut-btn.skip { border-color: #444; color: #666; }
  .tut-btn.skip:hover { background: #333; color: #aaa; }

  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: #000; }
  ::-webkit-scrollbar-thumb { background: #222; }
</style>
</head>
<body>

<div id="header">
  <h1>âš¡ JOP â€” DISPEÄŒINK v3.2</h1>
  <div class="status-bar">
    <span>ÄŒAS <span id="clock">--:--:--</span></span>
    <span class="live">â— LIVE</span>
    <span>VLAKY <span id="trainCount">0</span></span>
    <span>STOJÃ <span id="delayCount">0</span></span>
  </div>
</div>

<div id="canvasWrap">
  <canvas id="jop" width="1200" height="440"></canvas>
</div>

<div id="controls">
  <button class="btn tutorial" id="btnTutorial" onclick="startTutorial()">ğŸ“– VÃ½ukovÃ½ reÅ¾im</button>
  <button class="btn" onclick="spawnScheduled()">â–¶ JÃ­zdnÃ­ Å™Ã¡d</button>
  <button class="btn" onclick="spawnSingle('R 601','right')">+ R 601 â†’</button>
  <button class="btn" onclick="spawnSingle('Os 2814','right')">+ Os 2814 â†’</button>
  <button class="btn" onclick="spawnSingle('Ex 145','left')">â† Ex 145</button>
  <button class="btn" onclick="spawnSingle('Nex 780','left')">â† Nex 780</button>
  <button class="btn warn" onclick="toggleAuto()">âš™ Auto</button>
  <button class="btn danger" onclick="emergencyStop()">â›” NouzovÃ© zastavenÃ­</button>
</div>

<div id="infoPanel">
  <div class="info-card"><h3>AKTIVNÃ VLAKY</h3><div class="val" id="panelTrains">â€”</div></div>
  <div class="info-card"><h3>OBSAZENÃ‰ KOLEJE</h3><div class="val" id="panelTracks">â€”</div></div>
  <div class="info-card"><h3>REÅ½IM</h3><div class="val" id="panelMode">MANUÃLNÃ</div></div>
  <div class="info-card"><h3>BEZPEÄŒNOST</h3><div class="val" id="panelSafety" style="color:#00ff41">OK</div></div>
</div>

<div id="consoleWrap">
  <div id="console"></div>
</div>

<div id="tooltip"></div>

<!-- Tutorial overlay -->
<div id="tutOverlay">
  <div id="tutBox">
    <div id="tutStep"></div>
    <h2 id="tutTitle"></h2>
    <div id="tutContent"></div>
    <div class="tut-buttons" id="tutButtons"></div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  JOP v3.2 â€” DvÄ› stanice + VÃUKOVÃ REÅ½IM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const canvas = document.getElementById('jop');
const ctx = canvas.getContext('2d');
const W = canvas.width, H = canvas.height;

let simTime = 0;
let autoMode = false;
let emergencyMode = false;
let trainIdCounter = 0;

// â”€â”€ Tutorial state â”€â”€
let tutorialActive = false;
let tutorialStep = -1;
let tutHighlights = [];
let tutArrows = [];
let tutWaitFor = null;
let tutCheckInterval = null;

const STATIONS = [
  {
    name: "ZELENÃ LHOTA",
    cx: 200,
    tracks: [
      { id: "ZL-1", x1: 90, y1: 120, x2: 320, y2: 120 },
      { id: "ZL-2", x1: 90, y1: 170, x2: 320, y2: 170 },
      { id: "ZL-3", x1: 90, y1: 220, x2: 320, y2: 220 },
      { id: "ZL-4", x1: 90, y1: 270, x2: 320, y2: 270 },
    ],
    switches: [
      { id: "ZL-V1", x: 70, y: 195, state: 1, targets: [[90,120],[90,170],[90,220],[90,270]], label: "V1" },
      { id: "ZL-V2", x: 340, y: 195, state: 1, targets: [[320,120],[320,170],[320,220],[320,270]], label: "V2" },
    ],
    signals: [
      { id: "ZL-L",  x: 40,  y: 195, state: "stoj", dir: 1,  label: "L" },
      { id: "ZL-S1", x: 355, y: 120, state: "stoj", dir: 1,  label: "S1" },
      { id: "ZL-S2", x: 355, y: 170, state: "stoj", dir: 1,  label: "S2" },
      { id: "ZL-S3", x: 355, y: 220, state: "stoj", dir: 1,  label: "S3" },
      { id: "ZL-S4", x: 355, y: 270, state: "stoj", dir: 1,  label: "S4" },
      { id: "ZL-Lp", x: 40,  y: 215, state: "stoj", dir: -1, label: "Lp" },
    ],
    platformY: [120, 170, 220, 270],
  },
  {
    name: "SKALNÃ",
    cx: 1000,
    tracks: [
      { id: "SK-1", x1: 880, y1: 120, x2: 1110, y2: 120 },
      { id: "SK-2", x1: 880, y1: 170, x2: 1110, y2: 170 },
      { id: "SK-3", x1: 880, y1: 220, x2: 1110, y2: 220 },
      { id: "SK-4", x1: 880, y1: 270, x2: 1110, y2: 270 },
    ],
    switches: [
      { id: "SK-V1", x: 860, y: 195, state: 1, targets: [[880,120],[880,170],[880,220],[880,270]], label: "V1" },
      { id: "SK-V2", x: 1130, y: 195, state: 1, targets: [[1110,120],[1110,170],[1110,220],[1110,270]], label: "V2" },
    ],
    signals: [
      { id: "SK-L",  x: 1155, y: 195, state: "stoj", dir: -1, label: "L" },
      { id: "SK-S1", x: 845, y: 120, state: "stoj", dir: -1, label: "S1" },
      { id: "SK-S2", x: 845, y: 170, state: "stoj", dir: -1, label: "S2" },
      { id: "SK-S3", x: 845, y: 220, state: "stoj", dir: -1, label: "S3" },
      { id: "SK-S4", x: 845, y: 270, state: "stoj", dir: -1, label: "S4" },
      { id: "SK-Lp", x: 1155, y: 215, state: "stoj", dir: 1,  label: "Lp" },
    ],
    platformY: [120, 170, 220, 270],
  }
];

const LINES = [
  { id: "trat-A", x1: 355, y1: 195, x2: 845, y2: 195, label: "TraÅ¥: ZL â†’ SK" },
  { id: "trat-B", x1: 355, y1: 330, x2: 845, y2: 330, label: "TraÅ¥: SK â†’ ZL" },
];

const LINE_SIGNALS = [
  { id: "Ab-1", x: 520, y: 195, state: "stoj", dir: 1,  label: "Ab1" },
  { id: "Ab-2", x: 680, y: 195, state: "stoj", dir: 1,  label: "Ab2" },
  { id: "Ab-3", x: 680, y: 330, state: "stoj", dir: -1, label: "Ab3" },
  { id: "Ab-4", x: 520, y: 330, state: "stoj", dir: -1, label: "Ab4" },
];

let trains = [];

const TRAIN_TYPES = {
  "R":   { color: "#00aaff", speed: 1.8, priority: 3, len: 52 },
  "Os":  { color: "#00ff41", speed: 1.2, priority: 1, len: 38 },
  "Ex":  { color: "#ffcc00", speed: 2.2, priority: 4, len: 56 },
  "Nex": { color: "#ff3300", speed: 1.0, priority: 2, len: 62 },
  "SC":  { color: "#ff00ff", speed: 2.5, priority: 5, len: 48 },
};

function getTrainType(name) {
  return TRAIN_TYPES[name.split(' ')[0]] || TRAIN_TYPES["Os"];
}

function getAllSignals() {
  const s = [];
  STATIONS.forEach(st => st.signals.forEach(sig => s.push(sig)));
  LINE_SIGNALS.forEach(sig => s.push(sig));
  return s;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TUTORIAL SYSTEM â€” 14 krokÅ¯
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const TUTORIAL_STEPS = [
  {
    title: "VÃ­tejte ve vÃ½ukovÃ©m reÅ¾imu",
    content: `
      <p>NauÄÃ­te se ovlÃ¡dat Å¾elezniÄnÃ­ dispeÄink krok za krokem.</p>
      <p>SimulÃ¡tor obsahuje dvÄ› stanice â€” <span class="cyan">ZelenÃ¡ Lhota</span> (vlevo) a <span class="cyan">SkalnÃ¡</span> (vpravo), spojenÃ© tratÃ­.</p>
      <p>VaÅ¡Ã­m Ãºkolem je bezpeÄnÄ› provÃ©st vlaky z jednÃ© stanice do druhÃ©.</p>
      <p>ZvÃ½raznÄ›nÃ© prvky na mapÄ› vÃ¡m vÅ¾dy ukÃ¡Å¾Ã­, kam kliknout.</p>
    `,
    highlights: [], arrows: [], buttons: ["start"],
  },
  {
    title: "Krok 1 â€” Koleje",
    content: `
      <p>KaÅ¾dÃ¡ stanice mÃ¡ <span class="key">4 koleje</span> (ZL-1 aÅ¾ ZL-4 vlevo, SK-1 aÅ¾ SK-4 vpravo).</p>
      <p>Koleje jsou vodorovnÃ© ÄÃ¡ry. KdyÅ¾ po nich jede vlak, <span class="green">rozsvÃ­tÃ­ se zelenÄ›</span>.</p>
      <p>Na mapÄ› vidÃ­te zvÃ½raznÄ›nÃ© koleje stanice ZelenÃ¡ Lhota.</p>
    `,
    highlights: [
      {x:200, y:120, w:280, h:20},
      {x:200, y:170, w:280, h:20},
      {x:200, y:220, w:280, h:20},
      {x:200, y:270, w:280, h:20},
    ],
    arrows: [], buttons: ["next"],
  },
  {
    title: "Krok 2 â€” VÃ½hybky",
    content: `
      <p><span class="key">VÃ½hybky</span> jsou oranÅ¾ovÃ© body na zhlavÃ­ch stanic. UrÄujÃ­, na kterou kolej vlak odboÄÃ­.</p>
      <p>KliknutÃ­m na vÃ½hybku se cyklicky pÅ™epÃ­najÃ­ pozice (1â†’2â†’3â†’4â†’1...).</p>
      <p>OranÅ¾ovÃ¡ ÄÃ¡ra ukazuje aktuÃ¡lnÃ­ smÄ›rovÃ¡nÃ­.</p>
    `,
    highlights: [{x:70, y:195, r:22}, {x:340, y:195, r:22}],
    arrows: [], buttons: ["next"],
  },
  {
    title: "Krok 3 â€” NÃ¡vÄ›stidla",
    content: `
      <p><span class="key">NÃ¡vÄ›stidla</span> jsou signÃ¡lnÃ­ svÄ›tla. <span class="red">ÄŒervenÃ¡ = STÅ®J</span>, <span class="green">zelenÃ¡ = VOLNO</span>.</p>
      <p>Vlak zastavÃ­ pÅ™ed nÃ¡vÄ›stidlem v poloze STÅ®J. KliknutÃ­m pÅ™epnete.</p>
      <ul>
        <li><span class="key">L / Lp</span> â€” vstupnÃ­ (vpouÅ¡tÃ­ vlak do stanice)</li>
        <li><span class="key">S1â€“S4</span> â€” odjezdovÃ¡ (povolujÃ­ odjezd z koleje)</li>
        <li><span class="key">Ab1â€“Ab4</span> â€” traÅ¥ovÃ¡ (mezi stanicemi)</li>
      </ul>
    `,
    highlights: [
      {x:40, y:167, r:18}, {x:355, y:120, r:14}, {x:355, y:170, r:14},
      {x:355, y:220, r:14}, {x:355, y:270, r:14},
    ],
    arrows: [], buttons: ["next"],
  },
  {
    title: "Krok 4 â€” Vypravte vlak!",
    content: `
      <p>ZavÅ™ete toto okno a kliknÄ›te na tlaÄÃ­tko <span class="key">+ R 601 â†’</span> pod mapou.</p>
      <p>VypravÃ­te rychlÃ­k R 601 smÄ›rem â†’ SkalnÃ¡. Vlak se zastavÃ­ u prvnÃ­ho nÃ¡vÄ›stidla â€” to je sprÃ¡vnÄ›!</p>
    `,
    highlights: [], arrows: [],
    buttons: ["close-and-wait"],
    waitFor: () => trains.some(t => t.active && t.name === "R 601"),
  },
  {
    title: "Krok 5 â€” Nastavte vstupnÃ­ vÃ½hybku",
    content: `
      <p>Vlak R 601 stojÃ­ pÅ™ed nÃ¡vÄ›stidlem <span class="key">L</span>.</p>
      <p>KliknÄ›te na vÃ½hybku <span class="key">V1</span> (oranÅ¾ovÃ½ bod vlevo) a nastavte ji na pozici <span class="key">1</span> (kolej ZL-1 ÃºplnÄ› nahoÅ™e).</p>
      <p>Pokud je vÃ½hybka jinde, klikejte, dokud ÄÃ¡ra nesmÄ›Å™uje nahoru ke kolej ZL-1.</p>
    `,
    highlights: [{x:70, y:195, r:25}],
    arrows: [{x1:70, y1:155, x2:70, y2:178}],
    buttons: ["close-and-wait"],
    waitFor: () => STATIONS[0].switches[0].state === 0,
  },
  {
    title: "Krok 6 â€” OtevÅ™ete nÃ¡vÄ›stidlo L",
    content: `
      <p>VÃ½hybka V1 mÃ­Å™Ã­ na kolej 1 â€” vÃ½bornÄ›!</p>
      <p>KliknÄ›te na <span class="key">nÃ¡vÄ›stidlo L</span> (ÄervenÃ½ krouÅ¾ek vlevo od stanice) a pÅ™epnÄ›te na <span class="green">VOLNO</span>.</p>
      <p>TÃ­m dÃ¡te R 601 povolenÃ­ vjet do stanice.</p>
    `,
    highlights: [{x:40, y:167, r:22}],
    arrows: [{x1:40, y1:140, x2:40, y2:158}],
    buttons: ["close-and-wait"],
    waitFor: () => {
      const sig = STATIONS[0].signals.find(s => s.id === "ZL-L");
      return sig && sig.state === "volno";
    },
  },
  {
    title: "Krok 7 â€” Vlak vjÃ­Å¾dÃ­",
    content: `
      <p>R 601 vjÃ­Å¾dÃ­ do stanice ZelenÃ¡ Lhota na kolej 1.</p>
      <p>VÅ¡imnÄ›te si:</p>
      <ul>
        <li>NÃ¡vÄ›stidlo L se za vlakem <span class="red">automaticky zavÅ™elo</span></li>
        <li>Kolej ZL-1 <span class="green">svÃ­tÃ­ zelenÄ›</span> (obsazena)</li>
        <li>Vlak zastavÃ­ u nÃ¡stupiÅ¡tÄ› (odpoÄet Äasu)</li>
      </ul>
      <p>PoÄkejte, aÅ¾ vlak zastavÃ­...</p>
    `,
    highlights: [{x:200, y:120, w:280, h:24}],
    arrows: [],
    buttons: ["close-and-wait"],
    waitFor: () => {
      const t = trains.find(tr => tr.name === "R 601");
      return t && t.currentStation === "ZELENÃ LHOTA" && t.dwellTimer > 0;
    },
  },
  {
    title: "Krok 8 â€” PÅ™ipravte odjezd",
    content: `
      <p>Vlak stojÃ­ ve stanici. NynÃ­ proveÄte 3 kroky:</p>
      <ul>
        <li><span class="key">1.</span> KliknÄ›te na vÃ½stupnÃ­ vÃ½hybku <span class="key">V2</span> (vpravo od stanice)</li>
        <li><span class="key">2.</span> OtevÅ™ete odjezdovÃ© nÃ¡vÄ›stidlo <span class="key">S1</span> (u koleje 1)</li>
        <li><span class="key">3.</span> OtevÅ™ete traÅ¥ovÃ© nÃ¡vÄ›stidlo <span class="key">Ab1</span> (uprostÅ™ed trati)</li>
      </ul>
      <p>VÅ¡echny tÅ™i prvky jsou zvÃ½raznÄ›nÃ© na mapÄ›.</p>
    `,
    highlights: [
      {x:340, y:195, r:22},
      {x:355, y:92, r:18},
      {x:520, y:167, r:18},
    ],
    arrows: [],
    buttons: ["close-and-wait"],
    waitFor: () => {
      const s1 = STATIONS[0].signals.find(s => s.id === "ZL-S1");
      const ab = LINE_SIGNALS.find(s => s.id === "Ab-1");
      return s1 && s1.state === "volno" && ab && ab.state === "volno";
    },
  },
  {
    title: "Krok 9 â€” Vlak je na trati",
    content: `
      <p>R 601 odjÃ­Å¾dÃ­ smÄ›rem ke SkalnÃ©!</p>
      <p>PÅ™ipravte pÅ™Ã­jezd do SkalnÃ©:</p>
      <ul>
        <li>KliknÄ›te na vÃ½hybku <span class="key">SK-V1</span> (levÃ½ oranÅ¾ovÃ½ bod u SkalnÃ©) â€” nastavte ji na kolej, kam chcete vlak pÅ™ijmout</li>
        <li>OtevÅ™ete traÅ¥ovÃ© nÃ¡vÄ›stidlo <span class="key">Ab2</span> (druhÃ© na trati)</li>
      </ul>
    `,
    highlights: [
      {x:860, y:195, r:22},
      {x:680, y:167, r:18},
    ],
    arrows: [],
    buttons: ["close-and-wait"],
    waitFor: () => {
      const ab2 = LINE_SIGNALS.find(s => s.id === "Ab-2");
      return ab2 && ab2.state === "volno";
    },
  },
  {
    title: "Krok 10 â€” Vlak dorazil",
    content: `
      <p>VÃ½bornÄ›! R 601 projede do SkalnÃ© a po krÃ¡tkÃ©m stÃ¡nÃ­ odjede z mapy.</p>
      <p>ZnÃ¡te zÃ¡kladnÃ­ postup stavÄ›nÃ­ vlakovÃ© cesty:</p>
      <ul>
        <li><span class="key">1.</span> VÃ½hybka â†’ sprÃ¡vnÃ¡ kolej</li>
        <li><span class="key">2.</span> NÃ¡vÄ›stidlo â†’ VOLNO</li>
        <li><span class="key">3.</span> Vlak projede â†’ nÃ¡vÄ›stidlo se zavÅ™e</li>
        <li><span class="key">4.</span> VÃ½stupnÃ­ vÃ½hybka + odjezdovÃ© nÃ¡vÄ›stidlo</li>
        <li><span class="key">5.</span> TraÅ¥ovÃ¡ nÃ¡vÄ›stidla â†’ VOLNO</li>
      </ul>
    `,
    highlights: [], arrows: [],
    buttons: ["next"],
  },
  {
    title: "Krok 11 â€” ProtijedoucÃ­ vlak",
    content: `
      <p>Vlaky jezdÃ­ i opaÄnÃ½m smÄ›rem (â† ze SkalnÃ© do ZelenÃ© Lhoty).</p>
      <p>Postup je stejnÃ½, jen pouÅ¾Ã­vÃ¡te <span class="key">opaÄnÃ© prvky</span>:</p>
      <ul>
        <li>VstupnÃ­ nÃ¡vÄ›stidlo SkalnÃ© = <span class="key">SK-L</span></li>
        <li>VÃ½stupnÃ­ vÃ½hybka = <span class="key">SK-V2</span></li>
        <li>TraÅ¥ovÃ¡ nÃ¡vÄ›stidla = <span class="key">Ab3, Ab4</span> (spodnÃ­ Å™ada)</li>
      </ul>
      <p>Zkuste si to sami â€” stisknÄ›te <span class="key">â† Ex 145</span> a proveÄte vlak opaÄnÃ½m smÄ›rem!</p>
    `,
    highlights: [], arrows: [],
    buttons: ["next"],
  },
  {
    title: "Krok 12 â€” AutomatickÃ½ reÅ¾im",
    content: `
      <p>Nechcete stavÄ›t cesty ruÄnÄ›? ZapnÄ›te <span class="key">âš™ Auto</span>.</p>
      <p>SystÃ©m sÃ¡m:</p>
      <ul>
        <li>Najde volnou kolej</li>
        <li>NastavÃ­ vÃ½hybky a otevÅ™e nÃ¡vÄ›stidla</li>
        <li>Po stÃ¡nÃ­ pÅ™ipravÃ­ odjezdovou cestu</li>
      </ul>
      <p>VyzkouÅ¡ejte: zapnÄ›te Auto a stisknÄ›te <span class="key">â–¶ JÃ­zdnÃ­ Å™Ã¡d</span>.</p>
    `,
    highlights: [], arrows: [],
    buttons: ["next"],
  },
  {
    title: "Krok 13 â€” NouzovÃ© zastavenÃ­",
    content: `
      <p><span class="red">â›” NouzovÃ© zastavenÃ­</span> okamÅ¾itÄ›:</p>
      <ul>
        <li>ZavÅ™e <span class="red">vÅ¡echna nÃ¡vÄ›stidla</span></li>
        <li>ZastavÃ­ vÅ¡echny vlaky</li>
        <li>OpakovanÃ½m stiskem se zruÅ¡Ã­</li>
      </ul>
      <p>SystÃ©m takÃ© automaticky detekuje kolize a zastavÃ­ ohroÅ¾enÃ© vlaky.</p>
    `,
    highlights: [], arrows: [],
    buttons: ["next"],
  },
  {
    title: "VÃ½uka dokonÄena!",
    content: `
      <p>ShrnutÃ­ pro dispeÄera:</p>
      <ul>
        <li><span class="key">VÃ½hybka</span> (oranÅ¾ovÃ¡) â€” klik = pÅ™epnout kolej</li>
        <li><span class="key">NÃ¡vÄ›stidlo</span> (ÄervenÃ¡/zelenÃ¡) â€” klik = STÅ®J/VOLNO</li>
        <li><span class="key">Postup</span>: vÃ½hybka â†’ nÃ¡vÄ›stidlo â†’ vlak projede</li>
        <li><span class="key">Auto</span> = systÃ©m Å™Ã­dÃ­ sÃ¡m</li>
        <li><span class="key">Tooltip</span> = najeÄte myÅ¡Ã­ na prvek</li>
      </ul>
      <p>VÃ½uku spustÃ­te znovu tlaÄÃ­tkem <span class="cyan">ğŸ“– VÃ½ukovÃ½ reÅ¾im</span>.</p>
    `,
    highlights: [], arrows: [],
    buttons: ["finish"],
  },
];

function startTutorial() {
  trains = [];
  emergencyMode = false;
  autoMode = false;
  getAllSignals().forEach(s => s.state = 'stoj');
  STATIONS.forEach(st => st.switches.forEach(sw => sw.state = 1));
  document.getElementById('panelMode').textContent = 'MANUÃLNÃ';
  document.getElementById('panelMode').style.color = '#00ff41';
  document.getElementById('panelSafety').textContent = 'OK';
  document.getElementById('panelSafety').style.color = '#00ff41';

  tutorialActive = true;
  tutorialStep = -1;
  document.getElementById('btnTutorial').classList.add('active');
  log('ğŸ“– VÃ½ukovÃ½ reÅ¾im zahÃ¡jen.', 'tut');
  nextTutorialStep();
}

function endTutorial() {
  tutorialActive = false;
  tutorialStep = -1;
  tutHighlights = [];
  tutArrows = [];
  tutWaitFor = null;
  if (tutCheckInterval) { clearInterval(tutCheckInterval); tutCheckInterval = null; }
  document.getElementById('tutOverlay').classList.remove('show');
  document.getElementById('btnTutorial').classList.remove('active');
  log('ğŸ“– VÃ½ukovÃ½ reÅ¾im ukonÄen.', 'tut');
}

function nextTutorialStep() {
  tutorialStep++;
  if (tutorialStep >= TUTORIAL_STEPS.length) { endTutorial(); return; }
  showTutorialStep(tutorialStep);
}

function showTutorialStep(idx) {
  const step = TUTORIAL_STEPS[idx];
  document.getElementById('tutStep').textContent = `KROK ${idx}/${TUTORIAL_STEPS.length - 1}`;
  document.getElementById('tutTitle').textContent = step.title;
  document.getElementById('tutContent').innerHTML = step.content;

  tutHighlights = step.highlights || [];
  tutArrows = step.arrows || [];
  tutWaitFor = step.waitFor || null;

  const btns = document.getElementById('tutButtons');
  btns.innerHTML = '';

  step.buttons.forEach(b => {
    const el = document.createElement('button');
    el.className = 'tut-btn';
    if (b === 'start') {
      el.textContent = 'ZAÄŒÃT VÃUKU â†’'; el.className = 'tut-btn primary';
      el.onclick = () => nextTutorialStep();
    } else if (b === 'next') {
      el.textContent = 'POKRAÄŒOVAT â†’'; el.className = 'tut-btn primary';
      el.onclick = () => nextTutorialStep();
    } else if (b === 'close-and-wait') {
      el.textContent = 'ROZUMÃM â€” PROVEDU'; el.className = 'tut-btn primary';
      el.onclick = () => {
        document.getElementById('tutOverlay').classList.remove('show');
        if (tutWaitFor) {
          if (tutCheckInterval) clearInterval(tutCheckInterval);
          tutCheckInterval = setInterval(() => {
            if (tutWaitFor && tutWaitFor()) {
              clearInterval(tutCheckInterval); tutCheckInterval = null;
              log('âœ“ SprÃ¡vnÄ›!', 'tut');
              setTimeout(() => nextTutorialStep(), 600);
            }
          }, 200);
        }
      };
    } else if (b === 'finish') {
      el.textContent = 'DOKONÄŒIT VÃUKU'; el.className = 'tut-btn primary';
      el.onclick = () => endTutorial();
    }
    btns.appendChild(el);
  });

  if (step.buttons[0] !== 'finish') {
    const skip = document.createElement('button');
    skip.textContent = 'PÅ˜ESKOÄŒIT VÅ E'; skip.className = 'tut-btn skip';
    skip.onclick = () => endTutorial();
    btns.appendChild(skip);
  }

  document.getElementById('tutOverlay').classList.add('show');
}

function drawTutorialOverlay() {
  if (!tutorialActive) return;
  const t = (simTime % 60) / 60;

  // Highlights
  tutHighlights.forEach(h => {
    const p = 4 + Math.sin(t * Math.PI * 2) * 3;
    const alpha = 0.4 + Math.sin(t * Math.PI * 2) * 0.3;
    ctx.strokeStyle = `rgba(0,204,255,${alpha})`;
    ctx.lineWidth = 2.5;

    if (h.w && h.h) {
      ctx.strokeRect(h.x - h.w/2 - p, h.y - h.h/2 - p, h.w + p*2, h.h + p*2);
      ctx.fillStyle = `rgba(0,204,255,${0.03 + Math.sin(t * Math.PI * 2) * 0.02})`;
      ctx.fillRect(h.x - h.w/2 - p, h.y - h.h/2 - p, h.w + p*2, h.h + p*2);
    } else if (h.r) {
      ctx.beginPath(); ctx.arc(h.x, h.y, h.r + p, 0, Math.PI * 2); ctx.stroke();
      ctx.fillStyle = `rgba(0,204,255,${0.05 + Math.sin(t * Math.PI * 2) * 0.04})`;
      ctx.beginPath(); ctx.arc(h.x, h.y, h.r + p, 0, Math.PI * 2); ctx.fill();
    }
  });

  // Arrows (bouncing)
  tutArrows.forEach(a => {
    const bounce = Math.sin(t * Math.PI * 2) * 5;
    ctx.strokeStyle = '#00ccff'; ctx.lineWidth = 2;
    ctx.setLineDash([4, 3]);
    ctx.beginPath(); ctx.moveTo(a.x1, a.y1); ctx.lineTo(a.x2, a.y2 + bounce); ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle = '#00ccff'; ctx.beginPath();
    ctx.moveTo(a.x2, a.y2 + bounce + 6);
    ctx.lineTo(a.x2 - 5, a.y2 + bounce - 2);
    ctx.lineTo(a.x2 + 5, a.y2 + bounce - 2);
    ctx.fill();
  });

  // Badge
  ctx.fillStyle = 'rgba(0,204,255,0.15)'; ctx.fillRect(W - 140, 8, 130, 26);
  ctx.strokeStyle = '#00ccff'; ctx.lineWidth = 1; ctx.strokeRect(W - 140, 8, 130, 26);
  ctx.fillStyle = '#00ccff'; ctx.font = 'bold 11px Share Tech Mono'; ctx.textAlign = 'center';
  ctx.fillText(`ğŸ“– VÃUKA ${tutorialStep}/${TUTORIAL_STEPS.length - 1}`, W - 75, 25);
  ctx.textAlign = 'left';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SPAWN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function createTrain(name, dir) {
  const type = getTrainType(name);
  const t = {
    uid: ++trainIdCounter, name, dir: dir === 'right' ? 1 : -1,
    x: dir === 'right' ? -80 : W + 80,
    y: dir === 'right' ? 195 : 195,
    targetY: null, speed: type.speed, maxSpeed: type.speed,
    color: type.color, len: type.len, priority: type.priority,
    active: true, stopped: false, stoppedAt: null,
    phase: 'entering', currentStation: null, visitedStations: [],
    dwellTimer: 0, dwellDuration: 0,
  };
  trains.push(t);
  log(`Vlak <span class="info">${name}</span> vypraven (${dir === 'right' ? 'â†’' : 'â†'})`, 'info');
}

function spawnSingle(name, dir) {
  if (emergencyMode) { log('NouzovÃ© zastavenÃ­ aktivnÃ­!', 'err'); return; }
  createTrain(name, dir);
}

function spawnScheduled() {
  if (emergencyMode) { log('NouzovÃ© zastavenÃ­ aktivnÃ­!', 'err'); return; }
  log('JÃ­zdnÃ­ Å™Ã¡d spuÅ¡tÄ›n.', 'info');
  [
    { name: "R 601", dir: "right", delay: 0 },
    { name: "Ex 145", dir: "left", delay: 120 },
    { name: "Os 2814", dir: "right", delay: 260 },
    { name: "Nex 780", dir: "left", delay: 380 },
  ].forEach(s => setTimeout(() => { if (!emergencyMode) createTrain(s.name, s.dir); }, s.delay * 16));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUTO / EMERGENCY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function toggleAuto() {
  autoMode = !autoMode;
  document.getElementById('panelMode').textContent = autoMode ? 'AUTO' : 'MANUÃLNÃ';
  document.getElementById('panelMode').style.color = autoMode ? '#ffaa00' : '#00ff41';
  log(autoMode ? 'Auto reÅ¾im ZAPNUT' : 'Auto reÅ¾im VYPNUT', 'warn');
}

function emergencyStop() {
  emergencyMode = !emergencyMode;
  if (emergencyMode) {
    getAllSignals().forEach(s => s.state = 'stoj');
    trains.forEach(t => t.stopped = true);
    log('â›” NOUZOVÃ‰ ZASTAVENÃ!', 'err');
    document.getElementById('panelSafety').textContent = 'â›” NOUZOVÃ‰';
    document.getElementById('panelSafety').style.color = '#ff0000';
  } else {
    trains.forEach(t => t.stopped = false);
    log('NouzovÃ© zastavenÃ­ zruÅ¡eno.', 'warn');
    document.getElementById('panelSafety').textContent = 'OK';
    document.getElementById('panelSafety').style.color = '#00ff41';
  }
}

function autoControl() {
  if (!autoMode) return;
  trains.forEach(t => {
    if (!t.active) return;
    STATIONS.forEach(st => {
      const approaching = t.dir === 1
        ? (t.x > st.cx - 250 && t.x < st.cx - 160)
        : (t.x < st.cx + 250 && t.x > st.cx + 160);
      if (approaching && !t.currentStation && !t.visitedStations.includes(st.name)) {
        const fi = findFreeTrack(st, t);
        if (fi >= 0) {
          const eSw = t.dir === 1 ? st.switches[0] : st.switches[st.switches.length - 1];
          eSw.state = fi;
          st.signals.forEach(s => {
            if ((t.dir === 1 && s.dir === 1 && s.label === 'L') ||
                (t.dir === -1 && s.dir === -1 && s.label === 'L')) s.state = 'volno';
          });
          LINE_SIGNALS.forEach(ls => { if (ls.dir === t.dir) ls.state = 'volno'; });
        }
      }
      if (t.currentStation === st.name && t.dwellTimer <= 0 && t.phase === 'in-station') {
        const xSw = t.dir === 1 ? st.switches[st.switches.length - 1] : st.switches[0];
        xSw.state = 1;
        const trkI = st.platformY.indexOf(Math.round(t.y));
        const depSigs = st.signals.filter(s =>
          (t.dir === 1 && s.dir === 1 && s.label.startsWith('S')) ||
          (t.dir === -1 && s.dir === -1 && s.label.startsWith('S'))
        );
        if (depSigs[trkI]) depSigs[trkI].state = 'volno';
        LINE_SIGNALS.forEach(ls => { if (ls.dir === t.dir) ls.state = 'volno'; });
      }
    });
  });
}

function findFreeTrack(station, train) {
  const occ = new Set();
  trains.forEach(t => {
    if (!t.active || t.uid === train.uid) return;
    if (t.currentStation === station.name) {
      const yi = station.platformY.indexOf(Math.round(t.y));
      if (yi >= 0) occ.add(yi);
    }
  });
  for (let i = 0; i < station.platformY.length; i++) { if (!occ.has(i)) return i; }
  return -1;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UPDATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function update() {
  simTime++;
  autoControl();

  trains.forEach(t => {
    if (!t.active || t.stopped) return;

    let blocked = false;
    getAllSignals().forEach(sig => {
      if (sig.state !== 'stoj') return;
      const d = (t.x - sig.x) * t.dir;
      if (d > -65 && d < -5 && Math.abs(t.y - sig.y) < 50) {
        blocked = true; t.stoppedAt = sig.id;
      }
    });
    if (blocked) { t.speed = Math.max(0, t.speed - 0.06); }
    else { t.stoppedAt = null; t.speed = Math.min(t.maxSpeed, t.speed + 0.02); }

    STATIONS.forEach(st => {
      const inZ = t.x > st.cx - 80 && t.x < st.cx + 80;
      if (inZ && !t.visitedStations.includes(st.name) && t.phase !== 'in-station') {
        t.currentStation = st.name; t.phase = 'in-station';
        t.dwellDuration = t.priority >= 4 ? 100 : 200;
        t.dwellTimer = t.dwellDuration;
        log(`${t.name} â†’ stanice <span class="info">${st.name}</span>`, 'info');
      }
    });
    if (t.dwellTimer > 0) {
      t.dwellTimer--; t.speed = 0;
      if (t.dwellTimer === 0) {
        t.visitedStations.push(t.currentStation);
        log(`${t.name} odjÃ­Å¾dÃ­ z <span class="info">${t.currentStation}</span>`, 'info');
        t.currentStation = null; t.phase = 'line';
      }
      return;
    }

    STATIONS.forEach(st => {
      st.switches.forEach(sw => {
        if (Math.abs(t.x - sw.x) < 18) t.targetY = sw.targets[sw.state][1];
      });
    });
    if (t.targetY !== null) {
      const dy = t.targetY - t.y;
      if (Math.abs(dy) > 0.5) t.y += dy * 0.08;
      else { t.y = t.targetY; t.targetY = null; }
    }

    t.x += t.speed * t.dir;

    getAllSignals().forEach(sig => {
      const passed = (t.dir === 1 && t.x > sig.x + 10 && t.x < sig.x + 22) ||
                     (t.dir === -1 && t.x < sig.x - 10 && t.x > sig.x - 22);
      if (passed && sig.state === 'volno' && Math.abs(t.y - sig.y) < 50) sig.state = 'stoj';
    });

    if (t.x > W + 150 || t.x < -150) { t.active = false; log(`${t.name} opustil sÃ­Å¥.`, 'dim'); }
  });

  for (let i = 0; i < trains.length; i++) {
    for (let j = i + 1; j < trains.length; j++) {
      const a = trains[i], b = trains[j];
      if (!a.active || !b.active) continue;
      if (Math.abs(a.y - b.y) < 15 && Math.abs(a.x - b.x) < 40) {
        log(`âš  KOLIZE: ${a.name} â†” ${b.name}!`, 'err');
        a.speed = 0; b.speed = 0;
        document.getElementById('panelSafety').textContent = 'âš  KOLIZE';
        document.getElementById('panelSafety').style.color = '#ff0000';
      }
    }
  }

  trains = trains.filter(t => t.active);
  updatePanel();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DRAW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function draw() {
  ctx.clearRect(0, 0, W, H);

  ctx.strokeStyle = '#0a0a0a'; ctx.lineWidth = 0.5;
  for (let x = 0; x < W; x += 50) { ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, H); ctx.stroke(); }
  for (let y = 0; y < H; y += 50) { ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W, y); ctx.stroke(); }

  LINES.forEach(l => {
    ctx.strokeStyle = '#2a2a2a'; ctx.lineWidth = 3;
    ctx.setLineDash([10, 8]);
    ctx.beginPath(); ctx.moveTo(l.x1, l.y1); ctx.lineTo(l.x2, l.y2); ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle = '#333'; ctx.font = '10px Share Tech Mono';
    ctx.fillText(l.label, (l.x1 + l.x2) / 2 - 40, l.y1 - 10);
  });

  STATIONS.forEach(st => {
    const x1 = st.tracks[0].x1 - 25, x2 = st.tracks[0].x2 + 25;
    const y1 = st.tracks[0].y1 - 35, y2 = st.tracks[st.tracks.length - 1].y2 + 35;
    ctx.fillStyle = 'rgba(0,255,65,0.02)'; ctx.fillRect(x1, y1, x2 - x1, y2 - y1);
    ctx.strokeStyle = '#1a3a1a'; ctx.lineWidth = 1; ctx.strokeRect(x1, y1, x2 - x1, y2 - y1);

    ctx.fillStyle = '#00ff41'; ctx.font = 'bold 13px Orbitron'; ctx.textAlign = 'center';
    ctx.shadowBlur = 8; ctx.shadowColor = '#00ff41';
    ctx.fillText(st.name, st.cx, y1 - 12); ctx.shadowBlur = 0; ctx.textAlign = 'left';

    st.tracks.forEach(tk => {
      const occ = trains.some(t => t.active && Math.abs(t.y - tk.y1) < 15 && t.x > tk.x1 - 30 && t.x < tk.x2 + 30);
      ctx.strokeStyle = occ ? '#00ff41' : '#333'; ctx.lineWidth = occ ? 5 : 3;
      ctx.beginPath(); ctx.moveTo(tk.x1, tk.y1); ctx.lineTo(tk.x2, tk.y2); ctx.stroke();
      for (let px = tk.x1; px < tk.x2; px += 18) {
        ctx.strokeStyle = occ ? '#0a3a0a' : '#1a1a1a'; ctx.lineWidth = 1;
        ctx.beginPath(); ctx.moveTo(px, tk.y1 - 5); ctx.lineTo(px, tk.y1 + 5); ctx.stroke();
      }
      ctx.fillStyle = occ ? '#00ff41' : '#444'; ctx.font = 'bold 10px Share Tech Mono';
      ctx.fillText(tk.id, tk.x1 + 2, tk.y1 - 9);
      if (occ) { ctx.fillStyle = 'rgba(0,255,65,0.06)'; ctx.fillRect(tk.x1, tk.y1 - 12, tk.x2 - tk.x1, 24); }
    });

    st.switches.forEach(sw => {
      sw.targets.forEach((tg, i) => {
        ctx.strokeStyle = i === sw.state ? '#ffaa00' : '#1a1200'; ctx.lineWidth = i === sw.state ? 2.5 : 1;
        ctx.beginPath(); ctx.moveTo(sw.x, sw.y); ctx.lineTo(tg[0], tg[1]); ctx.stroke();
      });
      ctx.fillStyle = '#ffaa00'; ctx.shadowBlur = 10; ctx.shadowColor = '#ffaa00';
      ctx.beginPath(); ctx.arc(sw.x, sw.y, 6, 0, Math.PI * 2); ctx.fill(); ctx.shadowBlur = 0;
      ctx.strokeStyle = '#fff'; ctx.lineWidth = 1;
      ctx.beginPath(); ctx.arc(sw.x, sw.y, 6, 0, Math.PI * 2); ctx.stroke();
      ctx.fillStyle = '#ffaa00'; ctx.font = 'bold 10px Share Tech Mono';
      ctx.fillText(sw.label, sw.x - 6, sw.y + 20);
    });

    st.signals.forEach(sig => drawSignal(sig));
  });

  LINE_SIGNALS.forEach(sig => drawSignal(sig));

  trains.forEach(t => {
    if (!t.active) return;
    const hw = t.len / 2;
    ctx.fillStyle = 'rgba(0,0,0,0.6)'; ctx.fillRect(t.x - hw + 2, t.y - 6 + 3, t.len, 12);
    ctx.fillStyle = t.color; ctx.shadowBlur = 6; ctx.shadowColor = t.color;
    ctx.fillRect(t.x - hw, t.y - 7, t.len, 14); ctx.shadowBlur = 0;
    ctx.strokeStyle = '#fff'; ctx.lineWidth = 1; ctx.strokeRect(t.x - hw, t.y - 7, t.len, 14);
    const hlx = t.dir === 1 ? t.x + hw : t.x - hw;
    ctx.fillStyle = '#fff'; ctx.shadowBlur = 14; ctx.shadowColor = '#fff';
    ctx.beginPath(); ctx.arc(hlx, t.y, 3, 0, Math.PI * 2); ctx.fill(); ctx.shadowBlur = 0;
    ctx.fillStyle = '#fff'; ctx.font = 'bold 10px Share Tech Mono'; ctx.textAlign = 'center';
    ctx.shadowBlur = 4; ctx.shadowColor = '#000';
    ctx.fillText(t.name, t.x, t.y - 14); ctx.shadowBlur = 0;
    if (t.speed > 0) {
      ctx.fillStyle = '#888'; ctx.font = '9px Share Tech Mono';
      ctx.fillText(Math.round(t.speed * 50) + ' km/h', t.x, t.y + 24);
    } else if (t.dwellTimer > 0) {
      ctx.fillStyle = '#ffaa00'; ctx.font = 'bold 9px Share Tech Mono';
      ctx.fillText('â± ' + Math.ceil(t.dwellTimer / 60) + 's', t.x, t.y + 24);
    } else if (t.stoppedAt) {
      ctx.fillStyle = '#ff0000'; ctx.font = 'bold 9px Share Tech Mono';
      ctx.fillText('â— STOJ', t.x, t.y + 24);
    }
    ctx.textAlign = 'left';
  });

  drawLineDiagram();
  drawTutorialOverlay();
}

function drawSignal(sig) {
  const go = sig.state === 'volno';
  const col = go ? '#00ff41' : '#ff0000';
  ctx.strokeStyle = '#555'; ctx.lineWidth = 2;
  ctx.beginPath(); ctx.moveTo(sig.x, sig.y); ctx.lineTo(sig.x, sig.y - 22); ctx.stroke();
  ctx.fillStyle = col; ctx.shadowBlur = go ? 16 : 12; ctx.shadowColor = col;
  ctx.beginPath(); ctx.arc(sig.x, sig.y - 28, 7, 0, Math.PI * 2); ctx.fill();
  ctx.strokeStyle = '#fff'; ctx.lineWidth = 1; ctx.shadowBlur = 0;
  ctx.beginPath(); ctx.arc(sig.x, sig.y - 28, 7, 0, Math.PI * 2); ctx.stroke();
  ctx.fillStyle = '#111'; ctx.beginPath(); ctx.arc(sig.x, sig.y - 42, 5, 0, Math.PI * 2); ctx.fill();
  ctx.fillStyle = go ? '#111' : '#ffaa00';
  ctx.shadowBlur = go ? 0 : 6; ctx.shadowColor = '#ffaa00';
  ctx.beginPath(); ctx.arc(sig.x, sig.y - 42, 3.5, 0, Math.PI * 2); ctx.fill(); ctx.shadowBlur = 0;
  ctx.fillStyle = '#888'; ctx.font = 'bold 9px Share Tech Mono';
  ctx.fillText(sig.label, sig.x - 7, sig.y + 14);
}

function drawLineDiagram() {
  const y = H - 35;
  ctx.fillStyle = '#050505'; ctx.fillRect(0, H - 60, W, 60);
  ctx.strokeStyle = '#1a1a1a'; ctx.beginPath(); ctx.moveTo(0, H - 60); ctx.lineTo(W, H - 60); ctx.stroke();
  ctx.strokeStyle = '#333'; ctx.lineWidth = 2;
  ctx.beginPath(); ctx.moveTo(80, y); ctx.lineTo(W - 80, y); ctx.stroke();
  STATIONS.forEach(st => {
    ctx.fillStyle = '#00ff41'; ctx.shadowBlur = 6; ctx.shadowColor = '#00ff41';
    ctx.beginPath(); ctx.arc(st.cx, y, 5, 0, Math.PI * 2); ctx.fill(); ctx.shadowBlur = 0;
    ctx.fillStyle = '#888'; ctx.font = '10px Share Tech Mono'; ctx.textAlign = 'center';
    ctx.fillText(st.name, st.cx, y + 16); ctx.textAlign = 'left';
  });
  trains.forEach(t => {
    if (!t.active) return;
    ctx.fillStyle = t.color; ctx.shadowBlur = 4; ctx.shadowColor = t.color;
    ctx.beginPath(); ctx.arc(t.x, y, 4, 0, Math.PI * 2); ctx.fill(); ctx.shadowBlur = 0;
    ctx.fillStyle = t.color; ctx.beginPath();
    ctx.moveTo(t.x + t.dir * 7, y); ctx.lineTo(t.x + t.dir * 2, y - 3); ctx.lineTo(t.x + t.dir * 2, y + 3); ctx.fill();
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INTERACTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

canvas.addEventListener('click', (e) => {
  const rect = canvas.getBoundingClientRect();
  const mx = (e.clientX - rect.left) * (W / rect.width);
  const my = (e.clientY - rect.top) * (H / rect.height);

  STATIONS.forEach(st => {
    st.switches.forEach(sw => {
      if (Math.hypot(mx - sw.x, my - sw.y) < 20) {
        sw.state = (sw.state + 1) % sw.targets.length;
        log(`VÃ½hybka ${st.name}/${sw.label} â†’ poz. ${sw.state + 1}`, 'warn');
      }
    });
  });

  getAllSignals().forEach(sig => {
    if (Math.hypot(mx - sig.x, my - (sig.y - 28)) < 18) {
      sig.state = sig.state === 'stoj' ? 'volno' : 'stoj';
      log(`NÃ¡vÄ›stidlo ${sig.label}: ${sig.state === 'volno' ? 'VOLNO â—' : 'STÅ®J â—'}`, sig.state === 'volno' ? 'info' : 'warn');
    }
  });
});

const tooltip = document.getElementById('tooltip');
canvas.addEventListener('mousemove', (e) => {
  const rect = canvas.getBoundingClientRect();
  const mx = (e.clientX - rect.left) * (W / rect.width);
  const my = (e.clientY - rect.top) * (H / rect.height);
  let tip = null;

  STATIONS.forEach(st => {
    st.switches.forEach(sw => {
      if (Math.hypot(mx - sw.x, my - sw.y) < 20)
        tip = `VÃ½hybka ${st.name}/${sw.label} â€” poz. ${sw.state + 1}/${sw.targets.length}`;
    });
  });
  getAllSignals().forEach(sig => {
    if (Math.hypot(mx - sig.x, my - (sig.y - 28)) < 18)
      tip = `${sig.label}: ${sig.state === 'volno' ? 'VOLNO' : 'STÅ®J'}`;
  });
  trains.forEach(t => {
    if (t.active && Math.abs(mx - t.x) < t.len / 2 && Math.abs(my - t.y) < 14) {
      tip = `${t.name} | ${Math.round(t.speed * 50)} km/h | ${t.currentStation || 'traÅ¥'}`;
      if (t.dwellTimer > 0) tip += ` | odjezd ${Math.ceil(t.dwellTimer / 60)}s`;
      if (t.stoppedAt) tip += ` | stojÃ­ u ${t.stoppedAt}`;
    }
  });

  if (tip) {
    tooltip.style.display = 'block'; tooltip.textContent = tip;
    tooltip.style.left = (e.clientX + 14) + 'px'; tooltip.style.top = (e.clientY - 10) + 'px';
  } else { tooltip.style.display = 'none'; }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PANEL / CLOCK / LOG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function updatePanel() {
  const active = trains.filter(t => t.active);
  document.getElementById('trainCount').textContent = active.length;
  document.getElementById('delayCount').textContent = active.filter(t => t.stoppedAt).length;
  document.getElementById('panelTrains').textContent = active.map(t => t.name).join(', ') || 'â€”';
  const occ = new Set();
  trains.forEach(t => {
    if (!t.active) return;
    STATIONS.forEach(st => st.tracks.forEach(tk => {
      if (Math.abs(t.y - tk.y1) < 15 && t.x > tk.x1 - 30 && t.x < tk.x2 + 30) occ.add(tk.id);
    }));
  });
  document.getElementById('panelTracks').textContent = occ.size > 0 ? [...occ].join(', ') : 'â€”';
}

function updateClock() {
  document.getElementById('clock').textContent =
    new Date().toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
}
setInterval(updateClock, 1000); updateClock();

function log(msg, cls = '') {
  const c = document.getElementById('console');
  const t = new Date().toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
  c.innerHTML = `<span class="dim">[${t}]</span> <span class="${cls}">${msg}</span><br>` + c.innerHTML;
  const lines = c.innerHTML.split('<br>');
  if (lines.length > 200) c.innerHTML = lines.slice(0, 200).join('<br>');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function gameLoop() { update(); draw(); requestAnimationFrame(gameLoop); }

log('JOP v3.2 â€” dvÄ› stanice + vÃ½ukovÃ½ reÅ¾im.', 'info');
log('KliknÄ›te ğŸ“– VÃ½ukovÃ½ reÅ¾im pro prÅ¯vodce ovlÃ¡dÃ¡nÃ­m.', 'tut');
gameLoop();
</script>
</body>
</html>
