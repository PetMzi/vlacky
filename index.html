<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vibe Dispatcher 2026</title>
    <style>
        :root { --jop-bg: #0a0a0a; --jop-green: #00ff41; --jop-red: #ff3e3e; --jop-grey: #444; }
        body { background: var(--jop-bg); color: var(--jop-green); font-family: 'Consolas', monospace; margin: 0; display: flex; flex-direction: column; align-items: center; }
        #pult-header { width: 100%; padding: 10px 20px; background: #111; border-bottom: 2px solid var(--jop-grey); display: flex; justify-content: space-between; box-sizing: border-box; }
        canvas { background: #000; cursor: crosshair; margin-top: 20px; border: 1px solid #222; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .controls { margin-top: 15px; padding: 15px; background: rgba(0, 255, 65, 0.05); border: 1px solid var(--jop-grey); width: 950px; border-radius: 4px; }
        .log { color: #888; font-size: 0.85rem; height: 40px; overflow-y: auto; }
        .status-pill { padding: 2px 8px; border: 1px solid var(--jop-green); border-radius: 10px; font-size: 0.8rem; }
    </style>
</head>
<body>

<div id="pult-header">
    <div>DISPEČERSKÉ PRACOVIŠTĚ: <strong id="station-name">NAČÍTÁNÍ...</strong></div>
    <div class="status-pill">ONLINE / GITHUB PAGES</div>
</div>

<canvas id="jopCanvas" width="1000" height="500"></canvas>

<div class="controls">
    <div class="log" id="event-log">>> Inicializace systému...</div>
    <div style="margin-top: 10px; font-size: 0.7rem; color: #555;">
        OVLÁDÁNÍ: Klikni na uzel výhybky pro přestavení | Klikni na návěstidlo pro volbu cesty
    </div>
</div>

<script>
    const canvas = document.getElementById('jopCanvas');
    const ctx = canvas.getContext('2d');
    let mapData = null;

    // --- NAČÍTÁNÍ DAT ---
    async function loadMap() {
        try {
            const response = await fetch('mapa.json');
            mapData = await response.json();
            document.getElementById('station-name').innerText = mapData.stanice[0].jmeno;
            log("Mapa úspěšně načtena z JSON souboru.");
            render();
        } catch (err) {
            log("CHYBA: Nepodařilo se načíst mapa.json! Zkontroluj soubor na GitHubu.");
            console.error(err);
        }
    }

    function log(msg) {
        const logEl = document.getElementById('event-log');
        logEl.innerHTML = `>> ${msg}<br>${logEl.innerHTML}`;
    }

    // --- VYKRESLOVÁNÍ ---
    function render() {
        if (!mapData) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        const stanice = mapData.stanice[0];

        // 1. Vykresli statické koleje
        stanice.koleje.forEach(k => {
            drawTrack(k.x1, k.y1, k.x2, k.y2, k.occupied ? '#ff0000' : '#444', k.id);
        });

        // 2. Vykresli výhybky
        stanice.vyhybky.forEach(w => {
            const target = (w.state === 0) ? w.cil_prip : w.cil_odb;
            // Neaktivní směr (šedý)
            const inactiveTarget = (w.state === 0) ? w.cil_odb : w.cil_prip;
            drawTrack(w.x, w.y, inactiveTarget[0], inactiveTarget[1], '#222', "");
            // Aktivní směr (bílý/zelený podle "vibe")
            drawTrack(w.x, w.y, target[0], target[1], '#fff', w.id);
            
            // Čep výhybky
            ctx.fillStyle = w.state === 0 ? "#00ff41" : "#ffaa00";
            ctx.beginPath(); ctx.arc(w.x, w.y, 4, 0, Math.PI*2); ctx.fill();
        });
    }

    function drawTrack(x1, y1, x2, y2, color, label) {
        ctx.strokeStyle = color;
        ctx.lineWidth = 4;
        ctx.lineCap = "round";
        ctx.beginPath();
        ctx.moveTo(x1, y1);
        ctx.lineTo(x2, y2);
        ctx.stroke();
        
        if (label) {
            ctx.fillStyle = "#555";
            ctx.font = "9px Arial";
            ctx.fillText(label, (x1+x2)/2, (y1+y2)/2 - 10);
        }
    }

    // --- INTERAKCE ---
    canvas.addEventListener('click', (e) => {
        const rect = canvas.getBoundingClientRect();
        const mx = e.clientX - rect.left;
        const my = e.clientY - rect.top;

        if (!mapData) return;

        // Logika kliknutí na výhybku
        mapData.stanice[0].vyhybky.forEach(w => {
            if (Math.hypot(mx - w.x, my - w.y) < 20) {
                w.state = w.state === 0 ? 1 : 0;
                log(`Výhybka ${w.id} přestavena.`);
                render();
            }
        });
    });

    // Spuštění
    loadMap();
</script>
</body>
</html>
