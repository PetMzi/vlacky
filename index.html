<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>Vibe Dispatcher - Provoz</title>
    <style>
        body { background: #0a0a0a; color: #00ff41; font-family: 'Consolas', monospace; margin: 0; overflow: hidden; display: flex; flex-direction: column; align-items: center; }
        #header { width: 100%; padding: 10px; background: #111; border-bottom: 2px solid #333; text-align: center; }
        canvas { background: #000; border: 1px solid #222; margin-top: 10px; box-shadow: 0 0 20px rgba(0,255,65,0.1); }
        #console { width: 980px; height: 100px; background: #000; border: 1px solid #333; margin-top: 10px; padding: 10px; font-size: 0.8rem; overflow-y: auto; color: #888; }
        .btn-spawn { margin-top: 10px; padding: 10px; background: #00ff41; color: black; border: none; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

<div id="header">DISPEČERSKÉ PRACOVIŠTĚ: <span id="st-name">...</span></div>
<canvas id="jopCanvas" width="1000" height="400"></canvas>
<div id="console">>> Systém připraven. Čekám na data...</div>
<button class="btn-spawn" onclick="spawnTrain()">VYPLATIT VLAK</button>

<script>
    const canvas = document.getElementById('jopCanvas');
    const ctx = canvas.getContext('2d');
    let data = null;

    async function init() {
        try {
            const res = await fetch('mapa.json');
            data = await res.json();
            document.getElementById('st-name').innerText = data.stanice[0].jmeno;
            log("Mapa načtena. Klikni na návěstidlo pro povolení jízdy.");
            gameLoop();
        } catch (e) { log("Chyba načítání mapa.json!"); }
    }

    function log(msg) {
        const c = document.getElementById('console');
        c.innerHTML = `> ${msg}<br>` + c.innerHTML;
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const s = data.stanice[0];

        // 1. Koleje
        s.koleje.forEach(k => {
            ctx.strokeStyle = k.occupied ? "#ff3e3e" : "#333";
            ctx.lineWidth = 4;
            ctx.beginPath(); ctx.moveTo(k.x1, k.y1); ctx.lineTo(k.x2, k.y2); ctx.stroke();
        });

        // 2. Výhybky
        s.vyhybky.forEach(w => {
            const activePos = w.targets[w.state];
            ctx.strokeStyle = "#fff";
            ctx.beginPath(); ctx.moveTo(w.x, w.y); ctx.lineTo(activePos[0], activePos[1]); ctx.stroke();
            ctx.fillStyle = "#ffaa00";
            ctx.beginPath(); ctx.arc(w.x, w.y, 5, 0, 7); ctx.fill();
        });

        // 3. Návěstidla
        s.navestidla.forEach(n => {
            ctx.fillStyle = (n.state === "volno") ? "#00ff00" : "#ff0000";
            ctx.shadowBlur = 10; ctx.shadowColor = ctx.fillStyle;
            ctx.beginPath(); ctx.arc(n.x, n.y - 20, 6, 0, 7); ctx.fill();
            ctx.shadowBlur = 0;
            ctx.fillStyle = "#fff"; ctx.fillText(n.id, n.x - 10, n.y - 30);
        });

        // 4. Vlaky
        s.vlaky.forEach(v => {
            if(!v.active) return;
            ctx.fillStyle = "#ffff00";
            ctx.fillRect(v.x - 15, v.y - 8, 30, 16);
            ctx.fillStyle = "#000"; ctx.font = "9px Arial";
            ctx.fillText(v.id, v.x - 14, v.y + 3);
        });
    }

    function update() {
        if(!data) return;
        const s = data.stanice[0];

        s.vlaky.forEach(v => {
            if(!v.active) return;

            // Kontrola návěstidla před vlakem
            const signal = s.navestidla.find(n => v.x < n.x && n.x < v.x + 30);
            if(signal && signal.state === "stoj") {
                v.currentSpeed = 0; // Červená - vlak stojí
            } else {
                v.currentSpeed = v.speed;
                if(signal && signal.state === "volno") {
                    signal.state = "stoj"; // Projetí návěstidla - shození na stůj
                    log(`Vlak ${v.id} projel návěstidlo ${signal.id}.`);
                }
            }

            v.x += v.currentSpeed;

            // Dynamická změna Y podle výhybky W1
            if(v.x > 250 && v.x < 260) {
                const w1 = s.vyhybky.find(w => w.id === "W1");
                v.targetY = (w1.state === 0) ? 250 : 100;
            }
            if(v.targetY) {
                v.y += (v.targetY - v.y) * 0.1;
            }

            if(v.x > v.targetX) v.active = false;
        });
    }

    function spawnTrain() {
        const v = data.stanice[0].vlaky[0];
        v.x = 50; v.y = 250; v.active = true; v.targetY = 250;
        log(`Vlak ${v.id} je připraven k odjezdu.`);
    }

    canvas.addEventListener('click', (e) => {
        const rect = canvas.getBoundingClientRect();
        const mx = e.clientX - rect.left;
        const my = e.clientY - rect.top;

        // Klik na výhybku
        data.stanice[0].vyhybky.forEach(w => {
            if(Math.hypot(mx-w.x, my-w.y) < 20) {
                w.state = w.state === 0 ? 1 : 0;
                log(`Výhybka ${w.id} přestavena.`);
            }
        });

        // Klik na návěstidlo
        data.stanice[0].navestidla.forEach(n => {
            if(Math.hypot(mx-n.x, my-(n.y-20)) < 15) {
                n.state = (n.state === "stoj") ? "volno" : "stoj";
                log(`Návěstidlo ${n.id} přepnuto.`);
            }
        });
    });

    function gameLoop() {
        update();
        draw();
        requestAnimationFrame(gameLoop);
    }

    init();
</script>
</body>
</html>
