<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<title>JOP – Železniční Dispečink v3.1</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;700&display=swap');

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: #000;
    color: #00ff41;
    font-family: 'Share Tech Mono', 'Consolas', monospace;
    min-height: 100vh;
    overflow-x: hidden;
  }

  #header {
    background: #000;
    border-bottom: 2px solid #00ff41;
    padding: 10px 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  #header h1 {
    font-family: 'Orbitron', monospace;
    font-size: 1rem;
    letter-spacing: 4px;
    color: #00ff41;
    text-shadow: 0 0 12px rgba(0,255,65,0.6);
  }
  .status-bar {
    display: flex;
    gap: 24px;
    font-size: 0.78rem;
    color: #888;
  }
  .status-bar .live { color: #00ff41; animation: blink 1.2s infinite; }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.2} }

  #canvasWrap { display: flex; justify-content: center; padding: 12px; }
  canvas {
    background: #000;
    border: 2px solid #1a1a1a;
    cursor: crosshair;
    image-rendering: pixelated;
  }

  #controls {
    display: flex;
    justify-content: center;
    gap: 8px;
    padding: 6px 24px;
    flex-wrap: wrap;
  }
  .btn {
    padding: 10px 20px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.78rem;
    border: 2px solid #00ff41;
    background: #000;
    color: #00ff41;
    cursor: pointer;
    letter-spacing: 1px;
    transition: all 0.15s;
    text-transform: uppercase;
  }
  .btn:hover { background: #00ff41; color: #000; }
  .btn.danger { border-color: #ff0000; color: #ff0000; }
  .btn.danger:hover { background: #ff0000; color: #000; }
  .btn.warn { border-color: #ffaa00; color: #ffaa00; }
  .btn.warn:hover { background: #ffaa00; color: #000; }

  #consoleWrap { display: flex; justify-content: center; padding: 0 24px 12px; }
  #console {
    width: 100%;
    max-width: 1200px;
    height: 130px;
    background: #000;
    border: 1px solid #222;
    padding: 8px 12px;
    font-size: 0.72rem;
    overflow-y: auto;
    color: #555;
    line-height: 1.7;
  }
  #console .info { color: #00ff41; }
  #console .warn { color: #ffaa00; }
  #console .err { color: #ff0000; }
  #console .dim { color: #333; }

  #infoPanel {
    display: flex;
    justify-content: center;
    gap: 12px;
    padding: 0 24px 10px;
    flex-wrap: wrap;
  }
  .info-card {
    background: #000;
    border: 1px solid #222;
    padding: 8px 14px;
    font-size: 0.72rem;
    min-width: 180px;
  }
  .info-card h3 { color: #666; font-size: 0.62rem; letter-spacing: 2px; margin-bottom: 4px; }
  .info-card .val { color: #00ff41; font-size: 0.82rem; }

  #tooltip {
    position: fixed;
    background: #000;
    border: 1px solid #00ff41;
    color: #00ff41;
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.7rem;
    padding: 5px 10px;
    pointer-events: none;
    display: none;
    z-index: 100;
  }

  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: #000; }
  ::-webkit-scrollbar-thumb { background: #222; }
</style>
</head>
<body>

<div id="header">
  <h1>⚡ JOP — DISPEČINK v3.1</h1>
  <div class="status-bar">
    <span>ČAS <span id="clock">--:--:--</span></span>
    <span class="live">● LIVE</span>
    <span>VLAKY <span id="trainCount">0</span></span>
    <span>STOJÍ <span id="delayCount">0</span></span>
  </div>
</div>

<div id="canvasWrap">
  <canvas id="jop" width="1200" height="440"></canvas>
</div>

<div id="controls">
  <button class="btn" onclick="spawnScheduled()">▶ Jízdní řád</button>
  <button class="btn" onclick="spawnSingle('R 601','right')">+ R 601 →</button>
  <button class="btn" onclick="spawnSingle('Os 2814','right')">+ Os 2814 →</button>
  <button class="btn" onclick="spawnSingle('Ex 145','left')">← Ex 145</button>
  <button class="btn" onclick="spawnSingle('Nex 780','left')">← Nex 780</button>
  <button class="btn warn" onclick="toggleAuto()">⚙ Auto</button>
  <button class="btn danger" onclick="emergencyStop()">⛔ Nouzové zastavení</button>
</div>

<div id="infoPanel">
  <div class="info-card"><h3>AKTIVNÍ VLAKY</h3><div class="val" id="panelTrains">—</div></div>
  <div class="info-card"><h3>OBSAZENÉ KOLEJE</h3><div class="val" id="panelTracks">—</div></div>
  <div class="info-card"><h3>REŽIM</h3><div class="val" id="panelMode">MANUÁLNÍ</div></div>
  <div class="info-card"><h3>BEZPEČNOST</h3><div class="val" id="panelSafety" style="color:#00ff41">OK</div></div>
</div>

<div id="consoleWrap">
  <div id="console"></div>
</div>

<div id="tooltip"></div>

<script>
// ═══════════════════════════════════════════════════════════
//  JOP v3.1 — Dvě stanice, vysoký kontrast
// ═══════════════════════════════════════════════════════════

const canvas = document.getElementById('jop');
const ctx = canvas.getContext('2d');
const W = canvas.width, H = canvas.height;

let simTime = 0;
let autoMode = false;
let emergencyMode = false;
let trainIdCounter = 0;

// ── Dvě stanice ──
// [ZELENÁ LHOTA] ════════ trať ════════ [SKALNÁ]

const STATIONS = [
  {
    name: "ZELENÁ LHOTA",
    cx: 200,
    tracks: [
      { id: "ZL-1", x1: 90, y1: 120, x2: 320, y2: 120 },
      { id: "ZL-2", x1: 90, y1: 170, x2: 320, y2: 170 },
      { id: "ZL-3", x1: 90, y1: 220, x2: 320, y2: 220 },
      { id: "ZL-4", x1: 90, y1: 270, x2: 320, y2: 270 },
    ],
    switches: [
      { id: "ZL-V1", x: 70, y: 195, state: 1, targets: [[90,120],[90,170],[90,220],[90,270]], label: "V1" },
      { id: "ZL-V2", x: 340, y: 195, state: 1, targets: [[320,120],[320,170],[320,220],[320,270]], label: "V2" },
    ],
    signals: [
      { id: "ZL-L",  x: 40,  y: 195, state: "stoj", dir: 1,  label: "L" },
      { id: "ZL-S1", x: 355, y: 120, state: "stoj", dir: 1,  label: "S1" },
      { id: "ZL-S2", x: 355, y: 170, state: "stoj", dir: 1,  label: "S2" },
      { id: "ZL-S3", x: 355, y: 220, state: "stoj", dir: 1,  label: "S3" },
      { id: "ZL-S4", x: 355, y: 270, state: "stoj", dir: 1,  label: "S4" },
      { id: "ZL-Lp", x: 40,  y: 215, state: "stoj", dir: -1, label: "Lp" },
    ],
    platformY: [120, 170, 220, 270],
  },
  {
    name: "SKALNÁ",
    cx: 1000,
    tracks: [
      { id: "SK-1", x1: 880, y1: 120, x2: 1110, y2: 120 },
      { id: "SK-2", x1: 880, y1: 170, x2: 1110, y2: 170 },
      { id: "SK-3", x1: 880, y1: 220, x2: 1110, y2: 220 },
      { id: "SK-4", x1: 880, y1: 270, x2: 1110, y2: 270 },
    ],
    switches: [
      { id: "SK-V1", x: 860, y: 195, state: 1, targets: [[880,120],[880,170],[880,220],[880,270]], label: "V1" },
      { id: "SK-V2", x: 1130, y: 195, state: 1, targets: [[1110,120],[1110,170],[1110,220],[1110,270]], label: "V2" },
    ],
    signals: [
      { id: "SK-L",  x: 1155, y: 195, state: "stoj", dir: -1, label: "L" },
      { id: "SK-S1", x: 845, y: 120, state: "stoj", dir: -1, label: "S1" },
      { id: "SK-S2", x: 845, y: 170, state: "stoj", dir: -1, label: "S2" },
      { id: "SK-S3", x: 845, y: 220, state: "stoj", dir: -1, label: "S3" },
      { id: "SK-S4", x: 845, y: 270, state: "stoj", dir: -1, label: "S4" },
      { id: "SK-Lp", x: 1155, y: 215, state: "stoj", dir: 1,  label: "Lp" },
    ],
    platformY: [120, 170, 220, 270],
  }
];

// Traťové úseky
const LINES = [
  { id: "trat-A", x1: 355, y1: 195, x2: 845, y2: 195, label: "Trať: ZL → SK" },
  { id: "trat-B", x1: 355, y1: 330, x2: 845, y2: 330, label: "Trať: SK → ZL" },
];

// Autoblok na trati
const LINE_SIGNALS = [
  { id: "Ab-1", x: 520, y: 195, state: "stoj", dir: 1,  label: "Ab1" },
  { id: "Ab-2", x: 680, y: 195, state: "stoj", dir: 1,  label: "Ab2" },
  { id: "Ab-3", x: 680, y: 330, state: "stoj", dir: -1, label: "Ab3" },
  { id: "Ab-4", x: 520, y: 330, state: "stoj", dir: -1, label: "Ab4" },
];

// ── Vlaky ──
let trains = [];

const TRAIN_TYPES = {
  "R":   { color: "#00aaff", speed: 1.8, priority: 3, len: 52 },
  "Os":  { color: "#00ff41", speed: 1.2, priority: 1, len: 38 },
  "Ex":  { color: "#ffcc00", speed: 2.2, priority: 4, len: 56 },
  "Nex": { color: "#ff3300", speed: 1.0, priority: 2, len: 62 },
  "SC":  { color: "#ff00ff", speed: 2.5, priority: 5, len: 48 },
};

function getTrainType(name) {
  return TRAIN_TYPES[name.split(' ')[0]] || TRAIN_TYPES["Os"];
}

function getAllSignals() {
  const s = [];
  STATIONS.forEach(st => st.signals.forEach(sig => s.push(sig)));
  LINE_SIGNALS.forEach(sig => s.push(sig));
  return s;
}

// ═══════════════════════════════════════
//  SPAWN
// ═══════════════════════════════════════

function createTrain(name, dir) {
  const type = getTrainType(name);
  const t = {
    uid: ++trainIdCounter, name, dir: dir === 'right' ? 1 : -1,
    x: dir === 'right' ? -80 : W + 80,
    y: dir === 'right' ? 195 : 195,
    targetY: null, speed: type.speed, maxSpeed: type.speed,
    color: type.color, len: type.len, priority: type.priority,
    active: true, stopped: false, stoppedAt: null,
    phase: 'entering', currentStation: null, visitedStations: [],
    dwellTimer: 0, dwellDuration: 0,
  };
  trains.push(t);
  log(`Vlak <span class="info">${name}</span> vypraven (${dir === 'right' ? '→' : '←'})`, 'info');
}

function spawnSingle(name, dir) {
  if (emergencyMode) { log('Nouzové zastavení aktivní!', 'err'); return; }
  createTrain(name, dir);
}

function spawnScheduled() {
  if (emergencyMode) { log('Nouzové zastavení aktivní!', 'err'); return; }
  log('Jízdní řád spuštěn.', 'info');
  [
    { name: "R 601", dir: "right", delay: 0 },
    { name: "Ex 145", dir: "left", delay: 120 },
    { name: "Os 2814", dir: "right", delay: 260 },
    { name: "Nex 780", dir: "left", delay: 380 },
  ].forEach(s => setTimeout(() => { if (!emergencyMode) createTrain(s.name, s.dir); }, s.delay * 16));
}

// ═══════════════════════════════════════
//  AUTO / EMERGENCY
// ═══════════════════════════════════════

function toggleAuto() {
  autoMode = !autoMode;
  document.getElementById('panelMode').textContent = autoMode ? 'AUTO' : 'MANUÁLNÍ';
  document.getElementById('panelMode').style.color = autoMode ? '#ffaa00' : '#00ff41';
  log(autoMode ? 'Auto režim ZAPNUT' : 'Auto režim VYPNUT', 'warn');
}

function emergencyStop() {
  emergencyMode = !emergencyMode;
  if (emergencyMode) {
    getAllSignals().forEach(s => s.state = 'stoj');
    trains.forEach(t => t.stopped = true);
    log('⛔ NOUZOVÉ ZASTAVENÍ!', 'err');
    document.getElementById('panelSafety').textContent = '⛔ NOUZOVÉ';
    document.getElementById('panelSafety').style.color = '#ff0000';
  } else {
    trains.forEach(t => t.stopped = false);
    log('Nouzové zastavení zrušeno.', 'warn');
    document.getElementById('panelSafety').textContent = 'OK';
    document.getElementById('panelSafety').style.color = '#00ff41';
  }
}

function autoControl() {
  if (!autoMode) return;
  trains.forEach(t => {
    if (!t.active) return;
    STATIONS.forEach(st => {
      const approaching = t.dir === 1
        ? (t.x > st.cx - 250 && t.x < st.cx - 160)
        : (t.x < st.cx + 250 && t.x > st.cx + 160);
      if (approaching && !t.currentStation && !t.visitedStations.includes(st.name)) {
        const fi = findFreeTrack(st, t);
        if (fi >= 0) {
          const eSw = t.dir === 1 ? st.switches[0] : st.switches[st.switches.length - 1];
          eSw.state = fi;
          st.signals.forEach(s => {
            if ((t.dir === 1 && s.dir === 1 && s.label === 'L') ||
                (t.dir === -1 && s.dir === -1 && s.label === 'L')) s.state = 'volno';
          });
          LINE_SIGNALS.forEach(ls => { if (ls.dir === t.dir) ls.state = 'volno'; });
        }
      }
      if (t.currentStation === st.name && t.dwellTimer <= 0 && t.phase === 'in-station') {
        const xSw = t.dir === 1 ? st.switches[st.switches.length - 1] : st.switches[0];
        xSw.state = 1;
        const trkI = st.platformY.indexOf(Math.round(t.y));
        const depSigs = st.signals.filter(s =>
          (t.dir === 1 && s.dir === 1 && s.label.startsWith('S')) ||
          (t.dir === -1 && s.dir === -1 && s.label.startsWith('S'))
        );
        if (depSigs[trkI]) depSigs[trkI].state = 'volno';
        LINE_SIGNALS.forEach(ls => { if (ls.dir === t.dir) ls.state = 'volno'; });
      }
    });
  });
}

function findFreeTrack(station, train) {
  const occ = new Set();
  trains.forEach(t => {
    if (!t.active || t.uid === train.uid) return;
    if (t.currentStation === station.name) {
      const yi = station.platformY.indexOf(Math.round(t.y));
      if (yi >= 0) occ.add(yi);
    }
  });
  for (let i = 0; i < station.platformY.length; i++) { if (!occ.has(i)) return i; }
  return -1;
}

// ═══════════════════════════════════════
//  UPDATE
// ═══════════════════════════════════════

function update() {
  simTime++;
  autoControl();

  trains.forEach(t => {
    if (!t.active || t.stopped) return;

    // Signál
    let blocked = false;
    getAllSignals().forEach(sig => {
      if (sig.state !== 'stoj') return;
      const d = (t.x - sig.x) * t.dir;
      if (d > -65 && d < -5 && Math.abs(t.y - sig.y) < 50) {
        blocked = true;
        t.stoppedAt = sig.id;
      }
    });
    if (blocked) { t.speed = Math.max(0, t.speed - 0.06); }
    else { t.stoppedAt = null; t.speed = Math.min(t.maxSpeed, t.speed + 0.02); }

    // Zastavení ve stanici
    STATIONS.forEach(st => {
      const inZ = t.x > st.cx - 80 && t.x < st.cx + 80;
      if (inZ && !t.visitedStations.includes(st.name) && t.phase !== 'in-station') {
        t.currentStation = st.name;
        t.phase = 'in-station';
        t.dwellDuration = t.priority >= 4 ? 100 : 200;
        t.dwellTimer = t.dwellDuration;
        log(`${t.name} → stanice <span class="info">${st.name}</span>`, 'info');
      }
    });
    if (t.dwellTimer > 0) {
      t.dwellTimer--; t.speed = 0;
      if (t.dwellTimer === 0) {
        t.visitedStations.push(t.currentStation);
        log(`${t.name} odjíždí z <span class="info">${t.currentStation}</span>`, 'info');
        t.currentStation = null; t.phase = 'line';
      }
      return;
    }

    // Výhybky
    STATIONS.forEach(st => {
      st.switches.forEach(sw => {
        if (Math.abs(t.x - sw.x) < 18) t.targetY = sw.targets[sw.state][1];
      });
    });
    if (t.targetY !== null) {
      const dy = t.targetY - t.y;
      if (Math.abs(dy) > 0.5) t.y += dy * 0.08;
      else { t.y = t.targetY; t.targetY = null; }
    }

    t.x += t.speed * t.dir;

    // Zavřít návěstidlo za sebou
    getAllSignals().forEach(sig => {
      const passed = (t.dir === 1 && t.x > sig.x + 10 && t.x < sig.x + 22) ||
                     (t.dir === -1 && t.x < sig.x - 10 && t.x > sig.x - 22);
      if (passed && sig.state === 'volno' && Math.abs(t.y - sig.y) < 50) sig.state = 'stoj';
    });

    if (t.x > W + 150 || t.x < -150) { t.active = false; log(`${t.name} opustil síť.`, 'dim'); }
  });

  // Kolize
  for (let i = 0; i < trains.length; i++) {
    for (let j = i + 1; j < trains.length; j++) {
      const a = trains[i], b = trains[j];
      if (!a.active || !b.active) continue;
      if (Math.abs(a.y - b.y) < 15 && Math.abs(a.x - b.x) < 40) {
        log(`⚠ KOLIZE: ${a.name} ↔ ${b.name}!`, 'err');
        a.speed = 0; b.speed = 0;
        document.getElementById('panelSafety').textContent = '⚠ KOLIZE';
        document.getElementById('panelSafety').style.color = '#ff0000';
      }
    }
  }

  trains = trains.filter(t => t.active);
  updatePanel();
}

// ═══════════════════════════════════════
//  DRAW — vysoký kontrast
// ═══════════════════════════════════════

function draw() {
  ctx.clearRect(0, 0, W, H);

  // Grid
  ctx.strokeStyle = '#0a0a0a';
  ctx.lineWidth = 0.5;
  for (let x = 0; x < W; x += 50) { ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, H); ctx.stroke(); }
  for (let y = 0; y < H; y += 50) { ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W, y); ctx.stroke(); }

  // Tratě
  LINES.forEach(l => {
    ctx.strokeStyle = '#2a2a2a';
    ctx.lineWidth = 3;
    ctx.setLineDash([10, 8]);
    ctx.beginPath(); ctx.moveTo(l.x1, l.y1); ctx.lineTo(l.x2, l.y2); ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle = '#333';
    ctx.font = '10px Share Tech Mono';
    ctx.fillText(l.label, (l.x1 + l.x2) / 2 - 40, l.y1 - 10);
  });

  // Stanice
  STATIONS.forEach(st => {
    const x1 = st.tracks[0].x1 - 25;
    const x2 = st.tracks[0].x2 + 25;
    const y1 = st.tracks[0].y1 - 35;
    const y2 = st.tracks[st.tracks.length - 1].y2 + 35;

    // Oblast stanice
    ctx.fillStyle = 'rgba(0,255,65,0.02)';
    ctx.fillRect(x1, y1, x2 - x1, y2 - y1);
    ctx.strokeStyle = '#1a3a1a';
    ctx.lineWidth = 1;
    ctx.strokeRect(x1, y1, x2 - x1, y2 - y1);

    // Název
    ctx.fillStyle = '#00ff41';
    ctx.font = 'bold 13px Orbitron';
    ctx.textAlign = 'center';
    ctx.shadowBlur = 8; ctx.shadowColor = '#00ff41';
    ctx.fillText(st.name, st.cx, y1 - 12);
    ctx.shadowBlur = 0;
    ctx.textAlign = 'left';

    // Koleje
    st.tracks.forEach(tk => {
      const occ = trains.some(t => t.active && Math.abs(t.y - tk.y1) < 15 && t.x > tk.x1 - 30 && t.x < tk.x2 + 30);

      // Kolejový pás
      ctx.strokeStyle = occ ? '#00ff41' : '#333';
      ctx.lineWidth = occ ? 5 : 3;
      ctx.beginPath(); ctx.moveTo(tk.x1, tk.y1); ctx.lineTo(tk.x2, tk.y2); ctx.stroke();

      // Pražce
      const step = 18;
      for (let px = tk.x1; px < tk.x2; px += step) {
        ctx.strokeStyle = occ ? '#0a3a0a' : '#1a1a1a';
        ctx.lineWidth = 1;
        ctx.beginPath(); ctx.moveTo(px, tk.y1 - 5); ctx.lineTo(px, tk.y1 + 5); ctx.stroke();
      }

      // ID koleje
      ctx.fillStyle = occ ? '#00ff41' : '#444';
      ctx.font = 'bold 10px Share Tech Mono';
      ctx.fillText(tk.id, tk.x1 + 2, tk.y1 - 9);

      // Obsazení – zvýraznění
      if (occ) {
        ctx.fillStyle = 'rgba(0,255,65,0.06)';
        ctx.fillRect(tk.x1, tk.y1 - 12, tk.x2 - tk.x1, 24);
      }
    });

    // Výhybky
    st.switches.forEach(sw => {
      const active = sw.targets[sw.state];

      // Všechny cesty (dim)
      sw.targets.forEach((tg, i) => {
        ctx.strokeStyle = i === sw.state ? '#ffaa00' : '#1a1200';
        ctx.lineWidth = i === sw.state ? 2.5 : 1;
        ctx.beginPath(); ctx.moveTo(sw.x, sw.y); ctx.lineTo(tg[0], tg[1]); ctx.stroke();
      });

      // Bod
      ctx.fillStyle = '#ffaa00';
      ctx.shadowBlur = 10; ctx.shadowColor = '#ffaa00';
      ctx.beginPath(); ctx.arc(sw.x, sw.y, 6, 0, Math.PI * 2); ctx.fill();
      ctx.shadowBlur = 0;

      // Obrys
      ctx.strokeStyle = '#fff';
      ctx.lineWidth = 1;
      ctx.beginPath(); ctx.arc(sw.x, sw.y, 6, 0, Math.PI * 2); ctx.stroke();

      // Label
      ctx.fillStyle = '#ffaa00';
      ctx.font = 'bold 10px Share Tech Mono';
      ctx.fillText(sw.label, sw.x - 6, sw.y + 20);
    });

    // Návěstidla
    st.signals.forEach(sig => drawSignal(sig));
  });

  // Traťová návěstidla
  LINE_SIGNALS.forEach(sig => drawSignal(sig));

  // Vlaky
  trains.forEach(t => {
    if (!t.active) return;
    const hw = t.len / 2;

    // Stín
    ctx.fillStyle = 'rgba(0,0,0,0.6)';
    ctx.fillRect(t.x - hw + 2, t.y - 6 + 3, t.len, 12);

    // Tělo vlaku
    ctx.fillStyle = t.color;
    ctx.shadowBlur = 6; ctx.shadowColor = t.color;
    ctx.fillRect(t.x - hw, t.y - 7, t.len, 14);
    ctx.shadowBlur = 0;

    // Obrys
    ctx.strokeStyle = '#fff';
    ctx.lineWidth = 1;
    ctx.strokeRect(t.x - hw, t.y - 7, t.len, 14);

    // Světlo
    const hlx = t.dir === 1 ? t.x + hw : t.x - hw;
    ctx.fillStyle = '#fff';
    ctx.shadowBlur = 14; ctx.shadowColor = '#fff';
    ctx.beginPath(); ctx.arc(hlx, t.y, 3, 0, Math.PI * 2); ctx.fill();
    ctx.shadowBlur = 0;

    // Název
    ctx.fillStyle = '#fff';
    ctx.font = 'bold 10px Share Tech Mono';
    ctx.textAlign = 'center';
    ctx.shadowBlur = 4; ctx.shadowColor = '#000';
    ctx.fillText(t.name, t.x, t.y - 14);
    ctx.shadowBlur = 0;

    // Status
    if (t.speed > 0) {
      ctx.fillStyle = '#888';
      ctx.font = '9px Share Tech Mono';
      ctx.fillText(Math.round(t.speed * 50) + ' km/h', t.x, t.y + 24);
    } else if (t.dwellTimer > 0) {
      ctx.fillStyle = '#ffaa00';
      ctx.font = 'bold 9px Share Tech Mono';
      ctx.fillText('⏱ ' + Math.ceil(t.dwellTimer / 60) + 's', t.x, t.y + 24);
    } else if (t.stoppedAt) {
      ctx.fillStyle = '#ff0000';
      ctx.font = 'bold 9px Share Tech Mono';
      ctx.fillText('● STOJ', t.x, t.y + 24);
    }
    ctx.textAlign = 'left';
  });

  // Liniový diagram
  drawLineDiagram();
}

function drawSignal(sig) {
  const go = sig.state === 'volno';
  const col = go ? '#00ff41' : '#ff0000';

  // Sloupek
  ctx.strokeStyle = '#555';
  ctx.lineWidth = 2;
  ctx.beginPath(); ctx.moveTo(sig.x, sig.y); ctx.lineTo(sig.x, sig.y - 22); ctx.stroke();

  // Hlavní světlo
  ctx.fillStyle = col;
  ctx.shadowBlur = go ? 16 : 12;
  ctx.shadowColor = col;
  ctx.beginPath(); ctx.arc(sig.x, sig.y - 28, 7, 0, Math.PI * 2); ctx.fill();

  // Obrys
  ctx.strokeStyle = '#fff';
  ctx.lineWidth = 1;
  ctx.shadowBlur = 0;
  ctx.beginPath(); ctx.arc(sig.x, sig.y - 28, 7, 0, Math.PI * 2); ctx.stroke();

  // Druhé světlo (předvěst)
  ctx.fillStyle = '#111';
  ctx.beginPath(); ctx.arc(sig.x, sig.y - 42, 5, 0, Math.PI * 2); ctx.fill();
  ctx.fillStyle = go ? '#111' : '#ffaa00';
  ctx.shadowBlur = go ? 0 : 6; ctx.shadowColor = '#ffaa00';
  ctx.beginPath(); ctx.arc(sig.x, sig.y - 42, 3.5, 0, Math.PI * 2); ctx.fill();
  ctx.shadowBlur = 0;

  // Štítek
  ctx.fillStyle = '#888';
  ctx.font = 'bold 9px Share Tech Mono';
  ctx.fillText(sig.label, sig.x - 7, sig.y + 14);
}

function drawLineDiagram() {
  const y = H - 35;
  ctx.fillStyle = '#050505';
  ctx.fillRect(0, H - 60, W, 60);
  ctx.strokeStyle = '#1a1a1a';
  ctx.beginPath(); ctx.moveTo(0, H - 60); ctx.lineTo(W, H - 60); ctx.stroke();

  // Linie
  ctx.strokeStyle = '#333';
  ctx.lineWidth = 2;
  ctx.beginPath(); ctx.moveTo(80, y); ctx.lineTo(W - 80, y); ctx.stroke();

  // Stanice
  STATIONS.forEach(st => {
    ctx.fillStyle = '#00ff41';
    ctx.shadowBlur = 6; ctx.shadowColor = '#00ff41';
    ctx.beginPath(); ctx.arc(st.cx, y, 5, 0, Math.PI * 2); ctx.fill();
    ctx.shadowBlur = 0;
    ctx.fillStyle = '#888';
    ctx.font = '10px Share Tech Mono';
    ctx.textAlign = 'center';
    ctx.fillText(st.name, st.cx, y + 16);
    ctx.textAlign = 'left';
  });

  // Vlaky
  trains.forEach(t => {
    if (!t.active) return;
    ctx.fillStyle = t.color;
    ctx.shadowBlur = 4; ctx.shadowColor = t.color;
    ctx.beginPath(); ctx.arc(t.x, y, 4, 0, Math.PI * 2); ctx.fill();
    ctx.shadowBlur = 0;

    // Šipka směru
    ctx.fillStyle = t.color;
    ctx.beginPath();
    ctx.moveTo(t.x + t.dir * 7, y);
    ctx.lineTo(t.x + t.dir * 2, y - 3);
    ctx.lineTo(t.x + t.dir * 2, y + 3);
    ctx.fill();
  });
}

// ═══════════════════════════════════════
//  INTERAKCE
// ═══════════════════════════════════════

canvas.addEventListener('click', (e) => {
  const rect = canvas.getBoundingClientRect();
  const mx = (e.clientX - rect.left) * (W / rect.width);
  const my = (e.clientY - rect.top) * (H / rect.height);

  STATIONS.forEach(st => {
    st.switches.forEach(sw => {
      if (Math.hypot(mx - sw.x, my - sw.y) < 20) {
        sw.state = (sw.state + 1) % sw.targets.length;
        log(`Výhybka ${st.name}/${sw.label} → poz. ${sw.state + 1}`, 'warn');
      }
    });
  });

  getAllSignals().forEach(sig => {
    if (Math.hypot(mx - sig.x, my - (sig.y - 28)) < 18) {
      sig.state = sig.state === 'stoj' ? 'volno' : 'stoj';
      log(`Návěstidlo ${sig.label}: ${sig.state === 'volno' ? 'VOLNO ●' : 'STŮJ ●'}`, sig.state === 'volno' ? 'info' : 'warn');
    }
  });
});

const tooltip = document.getElementById('tooltip');
canvas.addEventListener('mousemove', (e) => {
  const rect = canvas.getBoundingClientRect();
  const mx = (e.clientX - rect.left) * (W / rect.width);
  const my = (e.clientY - rect.top) * (H / rect.height);
  let tip = null;

  STATIONS.forEach(st => {
    st.switches.forEach(sw => {
      if (Math.hypot(mx - sw.x, my - sw.y) < 20)
        tip = `Výhybka ${st.name}/${sw.label} — poz. ${sw.state + 1}/${sw.targets.length}`;
    });
  });
  getAllSignals().forEach(sig => {
    if (Math.hypot(mx - sig.x, my - (sig.y - 28)) < 18)
      tip = `${sig.label}: ${sig.state === 'volno' ? 'VOLNO' : 'STŮJ'}`;
  });
  trains.forEach(t => {
    if (t.active && Math.abs(mx - t.x) < t.len / 2 && Math.abs(my - t.y) < 14) {
      tip = `${t.name} | ${Math.round(t.speed * 50)} km/h | ${t.currentStation || 'trať'}`;
      if (t.dwellTimer > 0) tip += ` | odjezd ${Math.ceil(t.dwellTimer / 60)}s`;
      if (t.stoppedAt) tip += ` | stojí u ${t.stoppedAt}`;
    }
  });

  if (tip) {
    tooltip.style.display = 'block';
    tooltip.textContent = tip;
    tooltip.style.left = (e.clientX + 14) + 'px';
    tooltip.style.top = (e.clientY - 10) + 'px';
  } else { tooltip.style.display = 'none'; }
});

// ═══════════════════════════════════════
//  PANEL / HODINY / LOG
// ═══════════════════════════════════════

function updatePanel() {
  const active = trains.filter(t => t.active);
  document.getElementById('trainCount').textContent = active.length;
  document.getElementById('delayCount').textContent = active.filter(t => t.stoppedAt).length;
  document.getElementById('panelTrains').textContent = active.map(t => t.name).join(', ') || '—';
  const occ = new Set();
  trains.forEach(t => {
    if (!t.active) return;
    STATIONS.forEach(st => st.tracks.forEach(tk => {
      if (Math.abs(t.y - tk.y1) < 15 && t.x > tk.x1 - 30 && t.x < tk.x2 + 30) occ.add(tk.id);
    }));
  });
  document.getElementById('panelTracks').textContent = occ.size > 0 ? [...occ].join(', ') : '—';
}

function updateClock() {
  document.getElementById('clock').textContent =
    new Date().toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
}
setInterval(updateClock, 1000); updateClock();

function log(msg, cls = '') {
  const c = document.getElementById('console');
  const t = new Date().toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
  c.innerHTML = `<span class="dim">[${t}]</span> <span class="${cls}">${msg}</span><br>` + c.innerHTML;
  const lines = c.innerHTML.split('<br>');
  if (lines.length > 200) c.innerHTML = lines.slice(0, 200).join('<br>');
}

// ═══════════════════════════════════════
//  LOOP
// ═══════════════════════════════════════

function gameLoop() { update(); draw(); requestAnimationFrame(gameLoop); }

log('JOP v3.1 — dvě stanice, vysoký kontrast.', 'info');
log('Stanice: Zelená Lhota ↔ Skalná', 'info');
log('Klik na návěstidlo/výhybku = přepnout stav.', 'dim');
gameLoop();
</script>
</body>
</html>
