<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>JOP Bohumín - Simulátor</title>
    <style>
        body { background: #050505; color: #00ff41; font-family: 'Consolas', monospace; margin: 0; display: flex; flex-direction: column; align-items: center; }
        #pult { width: 1000px; padding: 10px; background: #111; border-bottom: 2px solid #333; text-align: center; font-weight: bold; }
        canvas { background: #000; border: 1px solid #222; margin-top: 20px; box-shadow: 0 0 20px rgba(0,255,65,0.1); }
        #console { width: 980px; height: 140px; background: #000; border: 1px solid #333; margin-top: 10px; padding: 10px; font-size: 0.8rem; overflow-y: auto; color: #888; }
        .controls { margin-top: 10px; }
        button { padding: 12px 24px; background: #00ff41; color: black; border: none; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div id="pult">JOP BOHUMÍN - CENTRÁLNÍ DISPEČINK</div>
<canvas id="jopCanvas" width="1000" height="450"></canvas>
<div id="console">>> Inicializace Bohumína...</div>
<div class="controls">
    <button onclick="spawn()">VYPLATIT PROVOZ</button>
</div>

<script>
    const canvas = document.getElementById('jopCanvas');
    const ctx = canvas.getContext('2d');
    let data = null;

    async function init() {
        try {
            const res = await fetch('./mapa.json');
            data = await res.json();
            log("Systém ONLINE. Připravte vjezdové cesty.");
            gameLoop();
        } catch (e) { log("CHYBA: mapa.json nenalezena!"); }
    }

    function log(msg) {
        const c = document.getElementById('console');
        c.innerHTML = `> ${msg}<br>` + c.innerHTML;
    }

    function draw() {
        if(!data) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const s = data.stanice[0];

        s.koleje.forEach(k => {
            ctx.strokeStyle = "#222"; ctx.lineWidth = 4;
            ctx.beginPath(); ctx.moveTo(k.x1, k.y1); ctx.lineTo(k.x2, k.y2); ctx.stroke();
        });

        s.vyhybky.forEach(w => {
            const target = w.targets[w.state];
            ctx.strokeStyle = "#fff"; ctx.beginPath(); ctx.moveTo(w.x, w.y); ctx.lineTo(target[0], target[1]); ctx.stroke();
            ctx.fillStyle = "#ffaa00"; ctx.beginPath(); ctx.arc(w.x, w.y, 6, 0, 7); ctx.fill();
        });

        s.navestidla.forEach(n => {
            ctx.fillStyle = (n.state === "volno") ? "#00ff00" : "#ff0000";
            ctx.shadowBlur = 10; ctx.shadowColor = ctx.fillStyle;
            ctx.beginPath(); ctx.arc(n.x, n.y - 20, 8, 0, 7); ctx.fill();
            ctx.shadowBlur = 0;
            ctx.fillStyle = "#fff"; ctx.fillText(n.id, n.x - 15, n.y - 35);
        });

        s.vlaky.forEach(v => {
            if(!v.active) return;
            ctx.fillStyle = v.color;
            ctx.fillRect(v.x - 20, v.y - 10, 40, 20);
            ctx.fillStyle = "#000"; ctx.font = "bold 9px Arial";
            ctx.fillText(v.id, v.x - 18, v.y + 3);
        });
    }

    function update() {
        if(!data) return;
        const s = data.stanice[0];
        s.vlaky.forEach(v => {
            if(!v.active) return;
            let canGo = true;

            s.navestidla.forEach(n => {
                // Vlak doprava (dir 1) zastaví před návěstidlem
                if(v.dir === 1 && v.x < n.x - 10 && v.x > n.x - 45 && n.state === "stoj") canGo = false;
                // Vlak doleva (dir -1) zastaví před návěstidlem
                if(v.dir === -1 && v.x > n.x + 10 && v.x < n.x + 45 && n.state === "stoj") canGo = false;

                // Shození návěstidla
                if(n.state === "volno" && Math.abs(v.x - n.x) < 5) {
                    n.state = "stoj";
                    log(`Vlak ${v.id} v obvodu výhybek.`);
                }
            });

            if(canGo) v.x += v.speed * v.dir;

            // Logika Bohumínských zhlaví
            if(v.dir === 1 && v.x > 290 && v.x < 310) v.tY = s.vyhybky[0].targets[s.vyhybky[0].state][1];
            if(v.dir === 1 && v.x > 790 && v.x < 810) v.tY = s.vyhybky[1].targets[s.vyhybky[1].state][1];
            if(v.dir === -1 && v.x < 310 && v.x > 290) v.tY = 250;

            if(v.tY) v.y += (v.tY - v.y) * 0.06;
            if(v.x > 1100 || v.x < -100) v.active = false;
        });
    }

    function spawn() {
        if(!data) return;
        data.stanice[0].vlaky.forEach(v => {
            v.x = (v.dir === 1) ? -50 : 1050;
            v.y = (v.dir === 1) ? 250 : 150;
            v.active = true; v.tY = v.y;
        });
        log("PROVOZ ZAHÁJEN: Pendolino od Ostravy, Náklad od Polska.");
    }

    canvas.addEventListener('click', (e) => {
        const rect = canvas.getBoundingClientRect();
        const mx = e.clientX - rect.left, my = e.clientY - rect.top;
        data.stanice[0].vyhybky.forEach(w => {
            if(Math.hypot(mx-w.x, my-w.y) < 25) {
                w.state = (w.state + 1) % w.targets.length;
                log(`Výhybka ${w.id} -> směr ${w.state + 1}`);
            }
        });
        data.stanice[0].navestidla.forEach(n => {
            if(Math.hypot(mx-n.x, my-(n.y-20)) < 25) {
                n.state = (n.state === "stoj") ? "volno" : "stoj";
                log(`Návěstidlo ${n.id} přepnuto.`);
            }
        });
    });

    function gameLoop() { update(); draw(); requestAnimationFrame(gameLoop); }
    init();
</script>
</body>
</html>
